<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Wasch-Portal</title>
<style>
  body { font-family: Arial, sans-serif; margin: 14px; max-width: 980px; }
  h1 { margin: 0 0 6px; }
  h2 { margin: 14px 0 8px; }
  label { font-weight: bold; display:block; margin-top: 10px; }
  input, select, textarea {
    width: 100%; padding: 10px; margin-top: 5px; box-sizing: border-box;
    font-size: 16px; border-radius: 10px; border: 1px solid #ddd;
  }
  button {
    width: 100%; padding: 11px; margin-top: 8px; cursor: pointer;
    font-size: 16px; border-radius: 10px; border: 1px solid #ddd; background: #f2f2f2;
  }
  .grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
  .card { border: 1px solid #ddd; border-radius: 12px; padding: 12px; background:#fff; }
  .muted { opacity: 0.85; }
  .small { font-size: 13px; opacity: 0.9; }
  .status { margin-top: 10px; padding: 10px; border-radius: 10px; border: 1px solid #ddd; background: #fafafa; }
  details { margin-top: 12px; }
  .row2 { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
  .topbar { display:flex; align-items:center; justify-content:space-between; gap: 10px; }
  .link { font-size: 14px; text-decoration: underline; cursor: pointer; opacity: 0.8; user-select:none; }
  .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; border:1px solid #ddd; font-size: 12px; }

  /* MaschinenÃ¼bersicht: Liste */
  #machinesOverview { border: 1px solid #ddd; border-radius: 12px; overflow:hidden; min-height: 44px; }
  .machine-row {
    display: grid;
    grid-template-columns: 26px 1fr auto;
    gap: 10px;
    align-items: center;
    padding: 10px;
    border-bottom: 1px solid #e0e0e0;
    background: #fff;
  }
  .machine-row:last-child { border-bottom: none; }
  .machine-status { width: 16px; height: 16px; border-radius: 50%; }
  .machine-status.free { background: #2e7d32; }
  .machine-status.busy { background: #1565c0; }
  .machine-status.bad  { background: #b00020; }
  :root[data-theme="highcontrast-magenta"] .machine-status.bad { background: #d81b60; }
  .machine-title { font-weight: bold; }
  .machine-sub { font-size: 13px; opacity: 0.85; }
  .machine-actions button { padding: 6px 10px; font-size: 14px; width:auto; margin:0; }

  /* MaschinenÃ¼bersicht: Karten */
  .machines-cards { display:grid; grid-template-columns: 1fr; gap: 10px; }
  .mcard { border:1px solid #ddd; border-radius: 12px; padding: 12px; background:#fff; display:flex; justify-content:space-between; align-items:center; gap: 10px; }
  .mleft { display:flex; align-items:center; gap: 10px; }
  .mdesc { display:flex; flex-direction:column; gap: 2px; }

  /* Buchungen farbig */
  .bcard { border:1px solid #ddd; border-radius: 12px; padding:12px; }
  .b-busy { background:#e3f2fd; }
  .b-bad  { background:#ffebee; }
  .b-top { display:flex; justify-content:space-between; align-items:flex-start; gap:10px; }

  /* Slots disabled */
  option[disabled] { color: #888; }
</style>
</head>
<body>

<div class="topbar">
  <div>
    <h1>Wasch-Portal</h1>
    <div class="small muted" id="subline">Cloudflare Worker + D1</div>
  </div>
  <div class="link" onclick="toggleAdmin()">Admin</div>
</div>

<div id="news" class="status" style="display:none;"></div>
<div id="status" class="status">Ladeâ€¦</div>

<h2>1) Zugang</h2>
<label>Zimmernummer</label>
<input id="room" placeholder="0 - 400" inputmode="numeric" />

<label>PersÃ¶nlicher PIN</label>
<input id="pin" type="password" placeholder="PIN" inputmode="numeric" />

<label>Stations-PIN (fÃ¼r Buchen erforderlich)</label>
<input id="stationPin" type="password" placeholder="Stations-PIN" inputmode="numeric" />

<button onclick="refreshAll()">Aktualisieren</button>

<h2>2) MaschinenÃ¼bersicht</h2>
<div id="machinesOverview"></div>

<h2>3) Waschmaschinen-Slot buchen</h2>
<label>Slot</label>
<select id="washerSlotSelect">
  <option value="">Bitte auswÃ¤hlen</option>
</select>
<div class="small muted" id="slotHint"></div>
<button onclick="bookWasher()">Buchen</button>

<h2>4) Meine Buchungen</h2>
<button onclick="loadMyBookings()">Meine Buchungen aktualisieren</button>
<div id="myBookings" class="grid"></div>

<details>
  <summary><b>Maschine als defekt melden / freigeben (mit Stations-PIN)</b></summary>
  <div class="row2">
    <div>
      <label>GerÃ¤t</label>
      <select id="defType">
        <option value="washer">Waschmaschine</option>
        <option value="dryer">Trockner</option>
      </select>
    </div>
    <div>
      <label>Nummer</label>
      <select id="defMachine">
        <option value="1">1</option><option value="2">2</option>
        <option value="3">3</option><option value="4">4</option>
      </select>
    </div>
  </div>
  <button onclick="userSetDefect('defect')">Als defekt melden</button>
  <button onclick="userSetDefect('free')">Freigeben</button>
</details>

<details open>
  <summary><b>Feedback / Chat</b></summary>
  <div class="small muted">Antworten werden angezeigt, sobald der Admin sie freigibt.</div>
  <button onclick="loadUserChat()">Chat aktualisieren</button>
  <div id="chatBox" class="grid" style="margin-top:10px;"></div>

  <label>Neue Nachricht</label>
  <textarea id="fb" rows="3" placeholder="Nachrichtâ€¦"></textarea>
  <button onclick="sendFeedback()">Senden</button>
</details>

<!-- Admin Panel -->
<div id="adminPanel" style="display:none; margin-top: 16px; border-top:1px solid #ddd; padding-top: 12px;">
  <h2>Admin</h2>

  <label>Admin-Passwort</label>
  <input id="adminPw" type="password" placeholder="Admin-Passwort" />
  <button onclick="adminUnlock()">Login</button>

  <div id="adminBody" style="display:none;">
    <details open>
      <summary><b>UI (global)</b></summary>

      <label>Theme</label>
      <select id="uiTheme">
        <option value="standard">Standard</option>
        <option value="highcontrast-magenta">High-Contrast (Magenta)</option>
      </select>
      <button onclick="adminSaveUITheme()">Theme speichern</button>

      <label>Layout</label>
      <select id="uiLayout">
        <option value="list">Liste</option>
        <option value="cards">Karten</option>
      </select>
      <button onclick="adminSaveUILayout()">Layout speichern</button>

      <label>Trocknerlaufzeit (nur neue Buchungen)</label>
      <select id="dryerMinutes">
        <option value="60">1 Stunde</option>
        <option value="90">1,5 Stunden</option>
        <option value="120">2 Stunden</option>
      </select>
      <button onclick="adminSaveDryerMinutes()">Speichern</button>
    </details>

    <details open>
      <summary><b>Slotzeiten (Waschmaschine)</b></summary>
      <div class="small muted">Haken setzen â†’ diese Zeiten werden pro Tag angeboten.</div>
      <div id="timeGrid" class="grid"></div>
      <button onclick="adminSaveTimes()">Slotzeiten speichern</button>
    </details>

    <details>
      <summary><b>Tage-Fenster</b></summary>
      <div class="row2">
        <div>
          <label>Vergangene Tage</label>
          <input id="daysPast" inputmode="numeric" />
        </div>
        <div>
          <label>Folgende Tage</label>
          <input id="daysFuture" inputmode="numeric" />
        </div>
      </div>
      <button onclick="adminSaveDays()">Speichern</button>
    </details>

    <details>
      <summary><b>Stations-PIN setzen</b></summary>
      <label>Stations-PIN</label>
      <input id="adminStationPin" type="password" placeholder="Stations-PIN" />
      <button onclick="adminSaveStationPin()">Stations-PIN speichern</button>
    </details>

    <details>
      <summary><b>User-Hinweis (oben)</b></summary>
      <label>Text</label>
      <textarea id="newsText" rows="3"></textarea>
      <label><input type="checkbox" id="newsEnabled"> Anzeigen</label>
      <button onclick="adminSaveNews()">Speichern</button>
    </details>

    <details open>
      <summary><b>Feedback Inbox</b></summary>
      <button onclick="adminLoadThreads()">Inbox aktualisieren</button>
      <div id="adminThreads" class="grid" style="margin-top:10px;"></div>

      <div id="adminThreadView" class="card" style="display:none; margin-top:10px;">
        <div id="adminThreadTitle" style="font-weight:bold;"></div>
        <label><input type="checkbox" id="adminVisible"> Antworten fÃ¼r User sichtbar</label>
        <div id="adminMsgs" class="grid" style="margin-top:10px;"></div>

        <label>Antwort</label>
        <textarea id="adminReply" rows="3"></textarea>
        <button onclick="adminSendReply()">Antwort senden</button>
      </div>
    </details>

    <details>
      <summary><b>Logout</b></summary>
      <button onclick="adminLogout()">Logout</button>
    </details>
  </div>
</div>

<script>
/** HIER DEINE WORKER URL (ohne Slash am Ende) */
const API_BASE = "https://snowy-breeze-54f8.schluffi1220.workers.dev";

const $ = (id) => document.getElementById(id);
function setStatus(msg){ $("status").textContent = msg; }

function apiUrl(path){
  return API_BASE.replace(/\/+$/,"") + "/" + String(path||"").replace(/^\/+/,"");
}
async function jget(path){
  const r = await fetch(apiUrl(path), { cache:"no-store" });
  const t = await r.text();
  try { return JSON.parse(t); } catch { return { ok:false, error:"bad_json", http:r.status, body:t.slice(0,200) }; }
}
async function jpost(path, body){
  const r = await fetch(apiUrl(path), {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body||{})
  });
  const t = await r.text();
  let data;
  try { data = JSON.parse(t); } catch { data = { ok:false, error:"bad_json", http:r.status, body:t.slice(0,200) }; }
  return { r, data };
}

function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}
function fmtTime(ms){
  return new Date(Number(ms)).toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"});
}
function fmtDate(ms){
  return new Date(Number(ms)).toLocaleDateString("de-DE");
}
function fmtDateTime(ms){
  return new Date(Number(ms)).toLocaleString("de-DE",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});
}
function applyTheme(theme){ document.documentElement.dataset.theme = theme || "standard"; }

function needAccess_(){
  const room = $("room").value.trim();
  const pin = $("pin").value.trim();
  const sp = $("stationPin").value.trim();
  return { room, pin, stationPin: sp };
}

let lastStatus = null;
let isAdmin = false;
let adminSelectedThread = null;

async function refreshAll(){
  await loadStatus();
  await loadWasherSlots();
  await loadMyBookings();
  await loadUserChat();
}

async function loadStatus(){
  setStatus("Lade Statusâ€¦");
  const data = await jget("/api/status");
  if(!data.ok){
    setStatus(`Fehler beim Laden (${data.http||"?"}): ${data.error||""} ${data.message||""} ${data.body||""}`);
    $("machinesOverview").innerHTML = "";
    $("washerSlotSelect").innerHTML = `<option value="">Keine Slots</option>`;
    return;
  }
  lastStatus = data;

  if(data.config?.uiTheme) applyTheme(data.config.uiTheme);

  const nt = String(data.newsText||"").trim();
  if(nt){
    $("news").style.display = "";
    $("news").textContent = nt;
  } else {
    $("news").style.display = "none";
  }

  renderMachinesOverview(data);
  setStatus("Bereit.");
}

function renderMachinesOverview(status){
  const layout = status.config?.uiLayout || "list";
  const box = $("machinesOverview");
  box.innerHTML = "";

  const machines = status.machines || [];
  const bookings = status.bookings || [];
  if(machines.length === 0){
    box.innerHTML = `<div class="machine-row"><div></div><div class="muted">Keine Maschinen</div><div></div></div>`;
    return;
  }

  const active = new Map();
  for(const b of bookings){
    if(b.status === "booked") active.set(`${b.type}:${b.machine}`, b);
  }

  machines.sort((a,b)=>{
    if(a.type !== b.type) return a.type.localeCompare(b.type);
    return Number(a.machine)-Number(b.machine);
  });

  if(layout === "cards"){
    const wrap = document.createElement("div");
    wrap.className = "machines-cards";

    for(const m of machines){
      const b = active.get(`${m.type}:${m.machine}`);
      let cls = "free";
      let text = "Frei";
      if(Number(m.defect) === 1){
        cls = "bad"; text = "Defekt";
      } else if(b){
        cls = "busy"; text = `Belegt bis ${fmtTime(b.end)} (Zimmer ${escapeHtml(b.room||"?")})`;
      }

      const card = document.createElement("div");
      card.className = "mcard";
      card.innerHTML = `
        <div class="mleft">
          <div class="machine-status ${cls}"></div>
          <div class="mdesc">
            <div class="machine-title">${m.type==="washer" ? "Waschmaschine" : "Trockner"} ${m.machine}</div>
            <div class="machine-sub">${text}</div>
          </div>
        </div>
        <div class="machine-actions"></div>
      `;

      const act = card.querySelector(".machine-actions");
      if(m.type === "dryer" && Number(m.defect) === 0){
        if(!b){
          const btn = document.createElement("button");
          btn.textContent = "Buchen";
          btn.onclick = () => bookDryer(Number(m.machine));
          act.appendChild(btn);
        } else {
          const mine = (window.myBookingsCache||[]).find(x => x.type==="dryer" && Number(x.machine)===Number(m.machine) && x.status==="booked");
          if(mine){
            const btn = document.createElement("button");
            btn.textContent = "FERTIG";
            btn.onclick = () => finishDryer(mine.id);
            act.appendChild(btn);
          }
        }
      }

      wrap.appendChild(card);
    }
    box.appendChild(wrap);
    return;
  }

  // list
  for(const m of machines){
    const b = active.get(`${m.type}:${m.machine}`);
    let cls = "free";
    let text = "Frei";
    if(Number(m.defect) === 1){
      cls = "bad"; text = "Defekt";
    } else if(b){
      cls = "busy"; text = `Belegt bis ${fmtTime(b.end)} (Zimmer ${escapeHtml(b.room||"?")})`;
    }

    const row = document.createElement("div");
    row.className = "machine-row";
    row.innerHTML = `
      <div class="machine-status ${cls}"></div>
      <div>
        <div class="machine-title">${m.type==="washer" ? "Waschmaschine" : "Trockner"} ${m.machine}</div>
        <div class="machine-sub">${text}</div>
      </div>
      <div class="machine-actions"></div>
    `;

    const act = row.querySelector(".machine-actions");
    if(m.type === "dryer" && Number(m.defect) === 0){
      if(!b){
        const btn = document.createElement("button");
        btn.textContent = "Buchen";
        btn.onclick = () => bookDryer(Number(m.machine));
        act.appendChild(btn);
      } else {
        const mine = (window.myBookingsCache||[]).find(x => x.type==="dryer" && Number(x.machine)===Number(m.machine) && x.status==="booked");
        if(mine){
          const btn = document.createElement("button");
          btn.textContent = "FERTIG";
          btn.onclick = () => finishDryer(mine.id);
          act.appendChild(btn);
        }
      }
    }

    box.appendChild(row);
  }
}

// ---------- Slots: Tage + Zeiten + disabled wenn belegt ----------
async function loadWasherSlots(){
  const sel = $("washerSlotSelect");
  const hint = $("slotHint");
  sel.innerHTML = `<option value="">Bitte auswÃ¤hlen</option>`;
  hint.textContent = "";

  if(!lastStatus?.ok){
    sel.innerHTML = `<option value="">Keine Slots</option>`;
    return;
  }

  const { room, pin, stationPin } = needAccess_();
  if(!room || !pin || !stationPin){
    sel.innerHTML = `<option value="">Bitte Zimmernummer, PIN und Stations-PIN eingeben</option>`;
    return;
  }

  const times = lastStatus.config?.washerTimes || [];
  if(!Array.isArray(times) || times.length === 0){
    sel.innerHTML = `<option value="">Keine Slots</option>`;
    return;
  }

  const daysPast = Number(lastStatus.config?.daysPast || 1);
  const daysFuture = Number(lastStatus.config?.daysFuture || 6);

  const machines = (lastStatus.machines||[]).filter(m => m.type==="washer" && Number(m.enabled)===1 && Number(m.defect)===0).map(m=>Number(m.machine));
  const bookings = (lastStatus.bookings||[]).filter(b => b.type==="washer" && b.status==="booked");

  const now = new Date();
  const base = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0,0,0,0);

  // group by day label
  for(let d=-daysPast; d<=daysFuture; d++){
    const day = new Date(base.getTime() + d*24*60*60*1000);
    const dayLabel = fmtDate(day.getTime());
    const optg = document.createElement("optgroup");
    optg.label = dayLabel;

    for(const t of times){
      const [hh,mm] = String(t).split(":").map(Number);
      if(Number.isNaN(hh)||Number.isNaN(mm)) continue;

      const start = new Date(day.getTime());
      start.setHours(hh,mm,0,0);
      const startMs = start.getTime();
      const endMs = startMs + 2*60*60*1000;

      // past slots today -> disable
      const isPast = startMs < Date.now();

      // count free machines for this slot
      let used = 0;
      for(const b of bookings){
        const overlap = !(Number(b.end) <= startMs || Number(b.start) >= endMs);
        if(overlap) used++;
      }
      const freeCount = Math.max(0, machines.length - used);
      const disabled = isPast || freeCount === 0;

      const opt = document.createElement("option");
      opt.value = String(startMs);
      opt.textContent = `${t} â€“ ${fmtTime(endMs)}  (${freeCount} frei)`;
      if(disabled){
        opt.disabled = true;
        opt.textContent += freeCount===0 ? "  (belegt)" : "  (vergangen)";
      }
      optg.appendChild(opt);
    }

    sel.appendChild(optg);
  }

  hint.textContent = "Belegte Slots sind grau und nicht auswÃ¤hlbar.";
}

async function loadMyBookings(){
  const box = $("myBookings");
  box.innerHTML = "";
  window.myBookingsCache = [];

  const { room, pin } = needAccess_();
  if(!room || !pin){
    box.innerHTML = `<div class="status">Bitte Zimmernummer und PIN eingeben.</div>`;
    return;
  }

  const { data } = await jpost("/api/my-bookings", { room, pin });
  if(!data.ok){
    box.innerHTML = `<div class="status">Fehler: ${escapeHtml(data.error||"")} ${escapeHtml(data.message||"")}</div>`;
    return;
  }

  window.myBookingsCache = data.bookings || [];

  for(const b of (data.bookings||[])){
    const isDefect = !!b.defect;
    const cls = isDefect ? "b-bad" : "b-busy";
    const card = document.createElement("div");
    card.className = `bcard ${cls}`;
    card.innerHTML = `
      <div class="b-top">
        <div>
          <div><b>${b.type==="washer" ? "Waschmaschine" : "Trockner"} ${b.machine}</b> ${isDefect ? '<span class="pill">Defekt</span>' : ''}</div>
          <div class="small muted">${fmtDateTime(b.start)} â€“ ${fmtTime(b.end)}</div>
        </div>
      </div>
    `;

    const btn = document.createElement("button");
    btn.textContent = b.canCancel ? "Stornieren" : "Storno nicht mÃ¶glich";
    btn.disabled = !b.canCancel;
    btn.onclick = () => cancelBooking(b.id);
    card.appendChild(btn);

    box.appendChild(card);
  }

  if(lastStatus?.ok) renderMachinesOverview(lastStatus);
}

// ---------- Booking actions ----------
async function bookWasher(){
  const { room, pin, stationPin } = needAccess_();
  const startMs = Number($("washerSlotSelect").value||0);
  if(!startMs) return alert("Bitte Slot auswÃ¤hlen.");
  if(!room || !pin || !stationPin) return alert("Bitte Zimmernummer, PIN, Stations-PIN eingeben.");

  const { data } = await jpost("/api/washer/book", { room, pin, stationPin, start: startMs });
  if(!data.ok) return alert((data.error||"Fehler") + (data.message ? (": "+data.message) : ""));
  alert(`âœ… Gebucht. Maschine ${data.machine}`);
  await refreshAll();
}
async function bookDryer(machine){
  const { room, pin, stationPin } = needAccess_();
  if(!room || !pin || !stationPin) return alert("Bitte Zimmernummer, PIN, Stations-PIN eingeben.");
  const { data } = await jpost("/api/dryer/book", { room, pin, stationPin, machine });
  if(!data.ok) return alert((data.error||"Fehler") + (data.message ? (": "+data.message) : ""));
  alert("âœ… Trockner gebucht.");
  await refreshAll();
}
async function finishDryer(bookingId){
  const { room, pin } = needAccess_();
  const { data } = await jpost("/api/dryer/finish", { room, pin, id: bookingId });
  if(!data.ok) return alert((data.error||"Fehler") + (data.message ? (": "+data.message) : ""));
  alert("âœ… Fertig gemeldet.");
  await refreshAll();
}
async function cancelBooking(id){
  const { room, pin } = needAccess_();
  const { data } = await jpost("/api/booking/cancel", { room, pin, id });
  if(!data.ok) return alert((data.error||"Fehler") + (data.message ? (": "+data.message) : ""));
  alert("âœ… Storniert.");
  await refreshAll();
}
async function userSetDefect(mode){
  const { room, pin, stationPin } = needAccess_();
  if(!room || !pin || !stationPin) return alert("Bitte Zimmernummer, PIN, Stations-PIN eingeben.");
  const type = $("defType").value;
  const machine = Number($("defMachine").value);
  const { data } = await jpost("/api/user/defect", { room, pin, stationPin, type, machine, mode });
  if(!data.ok) return alert((data.error||"Fehler") + (data.message ? (": "+data.message) : ""));
  alert("âœ… Gespeichert.");
  await refreshAll();
}

// ---------- Feedback/Chat (User) ----------
async function sendFeedback(){
  const { room, pin } = needAccess_();
  const msg = $("fb").value.trim();
  if(!room || !pin) return alert("Bitte Zimmernummer und PIN eingeben.");
  if(!msg) return alert("Bitte Text eingeben.");
  const { data } = await jpost("/api/feedback/send", { room, pin, message: msg });
  if(!data.ok) return alert((data.error||"Fehler") + (data.message ? (": "+data.message) : ""));
  $("fb").value = "";
  await loadUserChat();
}
async function loadUserChat(){
  const { room, pin } = needAccess_();
  const box = $("chatBox");
  box.innerHTML = "";
  if(!room || !pin){
    box.innerHTML = `<div class="status">Bitte Zimmernummer und PIN eingeben.</div>`;
    return;
  }
  const { data } = await jpost("/api/feedback/thread", { room, pin });
  if(!data.ok){
    box.innerHTML = `<div class="status">Fehler: ${escapeHtml(data.error||"")} ${escapeHtml(data.message||"")}</div>`;
    return;
  }
  if(data.hasNew){
    alert("ðŸ“© Neue Nachricht im Chat!");
  }
  const msgs = data.messages || [];
  if(msgs.length === 0){
    box.innerHTML = `<div class="status">Noch keine Nachrichten.</div>`;
    return;
  }
  for(const m of msgs){
    const c = document.createElement("div");
    c.className = "card";
    c.innerHTML = `<div class="small muted">${m.fromAdmin ? "Admin" : "Du"} Â· ${fmtDateTime(m.createdAt)}</div><div>${escapeHtml(m.message)}</div>`;
    box.appendChild(c);
  }
}

// ---------- Admin ----------
function toggleAdmin(){
  const p = $("adminPanel");
  p.style.display = (p.style.display==="none" ? "" : "none");
  if(p.style.display !== "none") $("adminPw").focus();
}
function adminPw_(){ return $("adminPw").value.trim(); }

window.addEventListener("load", () => {
  $("adminPw").addEventListener("keydown", (e) => {
    if(e.key === "Enter"){ e.preventDefault(); adminUnlock(); }
  });
});

async function adminUnlock(){
  const pw = adminPw_();
  if(!pw) return alert("Admin-Passwort fehlt.");
  const { data } = await jpost("/api/admin/has", { adminPassword: pw });
  if(!data.ok) return alert((data.error||"Fehler") + (data.message ? (": "+data.message) : ""));
  if(!data.hasAdmin) return alert("Admin nicht freigeschaltet oder Passwort falsch.");

  isAdmin = true;
  $("adminBody").style.display = "";

  await loadStatus();

  if(lastStatus?.config){
    $("uiTheme").value = lastStatus.config.uiTheme || "standard";
    $("uiLayout").value = lastStatus.config.uiLayout || "list";
    $("dryerMinutes").value = String(lastStatus.config.dryerMinutes || 120);
    $("daysPast").value = String(lastStatus.config.daysPast || 1);
    $("daysFuture").value = String(lastStatus.config.daysFuture || 6);
    $("newsText").value = lastStatus.newsText || "";
    $("newsEnabled").checked = !!(String(lastStatus.newsText||"").trim());
  }

  buildTimeGrid(lastStatus?.config?.washerTimes || []);
  await adminLoadThreads();
}
function adminLogout(){
  isAdmin = false;
  $("adminPw").value = "";
  $("adminBody").style.display = "none";
  adminSelectedThread = null;
  $("adminThreadView").style.display = "none";
  alert("âœ… Ausgeloggt.");
}

function buildTimeGrid(selected){
  const grid = $("timeGrid");
  grid.innerHTML = "";
  const set = new Set((selected||[]).map(String));
  const times = ["06:00","08:00","10:00","12:00","14:00","16:00","18:00","20:00","22:00"];
  for(const t of times){
    const id = "t_"+t.replace(":","");
    const wrap = document.createElement("label");
    wrap.style.display = "flex";
    wrap.style.alignItems = "center";
    wrap.style.gap = "10px";
    wrap.style.fontWeight = "normal";
    wrap.innerHTML = `<input type="checkbox" id="${id}"> <span>${t}</span>`;
    grid.appendChild(wrap);
    $(id).checked = set.has(t);
  }
}

async function adminSaveTimes(){
  const pw = adminPw_();
  const times = [];
  const all = ["06:00","08:00","10:00","12:00","14:00","16:00","18:00","20:00","22:00"];
  for(const t of all){
    const id = "t_"+t.replace(":","");
    if($(id)?.checked) times.push(t);
  }
  const { data } = await jpost("/api/admin/set-washer-times", { adminPassword: pw, washerTimes: times });
  if(!data.ok) return alert((data.error||"Fehler") + (data.message ? (": "+data.message) : ""));
  alert("âœ… Gespeichert.");
  await refreshAll();
}
async function adminSaveDays(){
  const pw = adminPw_();
  const daysPast = Number($("daysPast").value||1);
  const daysFuture = Number($("daysFuture").value||6);
  const { data } = await jpost("/api/admin/set-days", { adminPassword: pw, daysPast, daysFuture });
  if(!data.ok) return alert((data.error||"Fehler") + (data.message ? (": "+data.message) : ""));
  alert("âœ… Gespeichert.");
  await refreshAll();
}
async function adminSaveNews(){
  const pw = adminPw_();
  const enabled = $("newsEnabled").checked;
  const text = enabled ? $("newsText").value : "";
  const { data } = await jpost("/api/admin/set-news", { adminPassword: pw, newsText: text });
  if(!data.ok) return alert((data.error||"Fehler") + (data.message ? (": "+data.message) : ""));
  alert("âœ… Gespeichert.");
  await refreshAll();
}
async function adminSaveUITheme(){
  const pw = adminPw_();
  const theme = $("uiTheme").value;
  const { data } = await jpost("/api/admin/set-ui-theme", { adminPassword: pw, theme });
  if(!data.ok) return alert((data.error||"Fehler") + (data.message ? (": "+data.message) : ""));
  alert("âœ… Gespeichert.");
  await refreshAll();
}
async function adminSaveUILayout(){
  const pw = adminPw_();
  const layout = $("uiLayout").value;
  const { data } = await jpost("/api/admin/set-ui-layout", { adminPassword: pw, layout });
  if(!data.ok) return alert((data.error||"Fehler") + (data.message ? (": "+data.message) : ""));
  alert("âœ… Gespeichert.");
  await refreshAll();
}
async function adminSaveDryerMinutes(){
  const pw = adminPw_();
  const minutes = Number($("dryerMinutes").value||120);
  const { data } = await jpost("/api/admin/set-dryer-minutes", { adminPassword: pw, minutes });
  if(!data.ok) return alert((data.error||"Fehler") + (data.message ? (": "+data.message) : ""));
  alert("âœ… Gespeichert.");
  await refreshAll();
}
async function adminSaveStationPin(){
  const pw = adminPw_();
  const stationPin = $("adminStationPin").value.trim();
  if(!stationPin) return alert("Stations-PIN fehlt.");
  const { data } = await jpost("/api/admin/set-station-pin", { adminPassword: pw, stationPin });
  if(!data.ok) return alert((data.error||"Fehler") + (data.message ? (": "+data.message) : ""));
  $("adminStationPin").value = "";
  alert("âœ… Stations-PIN gespeichert.");
}

// ---------- Admin Feedback Inbox ----------
async function adminLoadThreads(){
  if(!isAdmin) return;
  const pw = adminPw_();
  const { data } = await jpost("/api/admin/feedback/list", { adminPassword: pw });
  if(!data.ok) return alert((data.error||"Fehler") + (data.message ? (": "+data.message) : ""));

  const box = $("adminThreads");
  box.innerHTML = "";
  for(const t of (data.threads||[])){
    const c = document.createElement("div");
    c.className = "card";
    c.innerHTML = `
      <div><b>Zimmer ${escapeHtml(t.room||"?")}</b> ${t.hasNew ? '<span class="pill">NEU</span>' : ''}</div>
      <div class="small muted">Letzte AktivitÃ¤t: ${fmtDateTime(t.updatedAt)}</div>
      <button style="width:auto;" onclick="adminOpenThread('${t.id}')">Ã–ffnen</button>
    `;
    box.appendChild(c);
  }
  if((data.threads||[]).length === 0){
    box.innerHTML = `<div class="status">Keine Feedbacks vorhanden.</div>`;
  }
}
async function adminOpenThread(threadId){
  const pw = adminPw_();
  const { data } = await jpost("/api/admin/feedback/get", { adminPassword: pw, threadId });
  if(!data.ok) return alert((data.error||"Fehler") + (data.message ? (": "+data.message) : ""));

  adminSelectedThread = data.thread;
  $("adminThreadView").style.display = "";
  $("adminThreadTitle").textContent = `Zimmer ${adminSelectedThread.room}`;
  $("adminVisible").checked = !!adminSelectedThread.adminVisible;

  renderAdminMsgs(data.messages||[]);
}
function renderAdminMsgs(msgs){
  const box = $("adminMsgs");
  box.innerHTML = "";
  for(const m of msgs){
    const c = document.createElement("div");
    c.className = "card";
    c.innerHTML = `
      <div class="small muted">${m.fromAdmin ? "Admin" : "User"} Â· ${fmtDateTime(m.createdAt)} ${m.fromAdmin ? (m.visibleToUser ? 'Â· sichtbar' : 'Â· verborgen') : ''}</div>
      <div>${escapeHtml(m.message)}</div>
    `;
    box.appendChild(c);
  }
}
async function adminSendReply(){
  const pw = adminPw_();
  const msg = $("adminReply").value.trim();
  if(!adminSelectedThread?.id) return alert("Kein Thread ausgewÃ¤hlt.");
  if(!msg) return alert("Antwort leer.");
  const visibleToUser = $("adminVisible").checked;

  const { data } = await jpost("/api/admin/feedback/reply", {
    adminPassword: pw,
    threadId: adminSelectedThread.id,
    message: msg,
    visibleToUser
  });

  if(!data.ok) return alert((data.error||"Fehler") + (data.message ? (": "+data.message) : ""));
  $("adminReply").value = "";

  // reload thread
  await adminOpenThread(adminSelectedThread.id);
  await adminLoadThreads();
}

// Init
refreshAll();
</script>
</body>
</html>
