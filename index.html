<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Wasch-Portal</title>
<style>
  body { font-family: Arial, sans-serif; margin: 14px; max-width: 980px; }
  h1 { margin: 0 0 6px; }
  h2 { margin: 14px 0 8px; }
  label { font-weight: bold; display:block; margin-top: 10px; }
  input, select, textarea {
    width: 100%; padding: 10px; margin-top: 5px; box-sizing: border-box;
    font-size: 16px; border-radius: 10px; border: 1px solid #ddd;
  }
  button {
    width: 100%; padding: 11px; margin-top: 8px; cursor: pointer;
    font-size: 16px; border-radius: 10px; border: 1px solid #ddd; background: #f2f2f2;
  }
  .grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
  .card { border: 1px solid #ddd; border-radius: 12px; padding: 12px; }
  .muted { opacity: 0.85; }
  .small { font-size: 13px; opacity: 0.9; }
  .status { margin-top: 10px; padding: 10px; border-radius: 10px; border: 1px solid #ddd; background: #fafafa; }
  details { margin-top: 12px; }
  .row2 { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
  .topbar { display:flex; align-items:center; justify-content:space-between; gap: 10px; }
  .link { font-size: 14px; text-decoration: underline; cursor: pointer; opacity: 0.8; user-select:none; }
  .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; border:1px solid #ddd; font-size: 12px; }

  /* ===== Maschinenübersicht: Liste ===== */
  #machinesOverview { border: 1px solid #ddd; border-radius: 12px; overflow:hidden; min-height: 44px; }
  .machine-row {
    display: grid;
    grid-template-columns: 26px 1fr auto;
    gap: 10px;
    align-items: center;
    padding: 10px;
    border-bottom: 1px solid #e0e0e0;
    background: #fff;
  }
  .machine-row:last-child { border-bottom: none; }
  .machine-status { width: 16px; height: 16px; border-radius: 50%; }
  .machine-status.free { background: #2e7d32; }
  .machine-status.busy { background: #1565c0; }
  .machine-status.bad  { background: #b00020; } /* Standard rot kräftig */

  /* High-contrast Theme (Magenta) */
  :root[data-theme="highcontrast-magenta"] .machine-status.bad { background: #d81b60; }
  :root[data-theme="highcontrast-magenta"] .machine-status.free { background: #1b5e20; }
  :root[data-theme="highcontrast-magenta"] .machine-status.busy { background: #0d47a1; }

  .machine-title { font-weight: bold; }
  .machine-sub { font-size: 13px; opacity: 0.85; }
  .machine-actions button { padding: 6px 10px; font-size: 14px; width:auto; margin:0; }

  /* ===== Buchungen farbig ===== */
  .bcard { border:1px solid #ddd; border-radius: 12px; padding:12px; }
  .b-busy { background:#e3f2fd; }
  .b-bad  { background:#ffebee; }
  .b-top { display:flex; justify-content:space-between; align-items:flex-start; gap:10px; }
</style>
</head>
<body>

<div class="topbar">
  <div>
    <h1>Wasch-Portal</h1>
    <div class="small muted" id="subline">Cloudflare Worker + D1</div>
  </div>
  <div class="link" onclick="toggleAdmin()">Admin</div>
</div>

<div id="news" class="status" style="display:none;"></div>
<div id="status" class="status">Lade…</div>

<h2>1) Zugang</h2>
<label>Zimmernummer</label>
<input id="room" placeholder="0 - 400" inputmode="numeric" />

<label>Persönlicher PIN</label>
<input id="pin" type="password" placeholder="PIN" inputmode="numeric" />

<label>Stations-PIN (für Buchen erforderlich)</label>
<input id="stationPin" type="password" placeholder="Stations-PIN" inputmode="numeric" />

<button onclick="refreshAll()">Aktualisieren</button>

<h2>2) Maschinenübersicht</h2>
<div id="machinesOverview"></div>

<h2>3) Waschmaschinen-Slot buchen</h2>
<label>Slot</label>
<select id="washerSlotSelect">
  <option value="">Bitte auswählen</option>
</select>
<button onclick="bookWasher()">Buchen</button>

<h2>4) Meine Buchungen</h2>
<button onclick="loadMyBookings()">Meine Buchungen aktualisieren</button>
<div id="myBookings" class="grid"></div>

<details>
  <summary><b>Maschine als defekt melden / freigeben (mit Stations-PIN)</b></summary>
  <div class="row2">
    <div>
      <label>Gerät</label>
      <select id="defType">
        <option value="washer">Waschmaschine</option>
        <option value="dryer">Trockner</option>
      </select>
    </div>
    <div>
      <label>Nummer</label>
      <select id="defMachine">
        <option value="1">1</option><option value="2">2</option>
        <option value="3">3</option><option value="4">4</option>
      </select>
    </div>
  </div>
  <button onclick="userSetDefect('defect')">Als defekt melden</button>
  <button onclick="userSetDefect('free')">Freigeben</button>
</details>

<details>
  <summary><b>Feedback / Problem melden</b></summary>
  <label>Feedback</label>
  <textarea id="fb" rows="4" placeholder="Was ist aufgefallen?"></textarea>
  <button onclick="sendFeedback()">Feedback senden</button>
</details>

<!-- Admin Panel -->
<div id="adminPanel" style="display:none; margin-top: 16px; border-top:1px solid #ddd; padding-top: 12px;">
  <h2>Admin</h2>

  <label>Admin-Passwort</label>
  <input id="adminPw" type="password" placeholder="Admin-Passwort" />
  <button onclick="adminUnlock()">Login</button>

  <div id="adminBody" style="display:none;">

    <details open>
      <summary><b>UI Einstellungen (global)</b></summary>

      <label>Theme</label>
      <select id="uiTheme">
        <option value="standard">Standard</option>
        <option value="highcontrast-magenta">High-Contrast (Magenta)</option>
      </select>
      <button onclick="adminSaveUITheme()">Theme speichern</button>

      <label>Trocknerlaufzeit (nur neue Buchungen)</label>
      <select id="dryerMinutes">
        <option value="60">1 Stunde</option>
        <option value="90">1,5 Stunden</option>
        <option value="120">2 Stunden</option>
      </select>
      <button onclick="adminSaveDryerMinutes()">Speichern</button>
    </details>

    <details open>
      <summary><b>Waschmaschinen Slotzeiten</b></summary>
      <div class="small muted">Haken setzen → diese Zeiten werden als Slots verwendet.</div>
      <div id="timeGrid" class="grid"></div>
      <button onclick="adminSaveTimes()">Slotzeiten speichern</button>
    </details>

    <details>
      <summary><b>Tage-Fenster</b></summary>
      <div class="row2">
        <div>
          <label>Vergangene Tage</label>
          <input id="daysPast" inputmode="numeric" />
        </div>
        <div>
          <label>Folgende Tage</label>
          <input id="daysFuture" inputmode="numeric" />
        </div>
      </div>
      <button onclick="adminSaveDays()">Speichern</button>
    </details>

    <details>
      <summary><b>Neu in der Version (User-Anzeige)</b></summary>
      <label>Text</label>
      <textarea id="newsText" rows="4"></textarea>
      <label><input type="checkbox" id="newsEnabled"> Für User anzeigen</label>
      <button onclick="adminSaveNews()">Speichern</button>
    </details>

    <details>
      <summary><b>Admin Logout</b></summary>
      <button onclick="adminLogout()">Logout</button>
    </details>

  </div>
</div>

<script>
/** ✅ WICHTIG: HIER DEINE WORKER-URL EINTRAGEN (ohne / am Ende) */
const API_BASE = "https://snowy-breeze-54f8.schluffi1220.workers.dev";

const $ = (id) => document.getElementById(id);
function setStatus(msg){ $("status").textContent = msg; }

function apiUrl(path){
  return API_BASE.replace(/\/+$/,"") + "/" + String(path||"").replace(/^\/+/,"");
}

async function jget(path){
  const r = await fetch(apiUrl(path), { cache:"no-store" });
  const txt = await r.text();
  try { return JSON.parse(txt); } catch { return { ok:false, error:"bad_json", http:r.status, body: txt.slice(0,200) }; }
}
async function jpost(path, body){
  const r = await fetch(apiUrl(path), {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body||{})
  });
  const txt = await r.text();
  let data;
  try { data = JSON.parse(txt); } catch { data = { ok:false, error:"bad_json", http:r.status, body: txt.slice(0,200) }; }
  return { r, data };
}

function needAccess_(){
  const room = $("room").value.trim();
  const pin = $("pin").value.trim();
  const sp = $("stationPin").value.trim();
  return { room, pin, stationPin: sp };
}

function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

function fmtTime(ms){
  return new Date(Number(ms)).toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"});
}
function fmtDateTime(ms){
  return new Date(Number(ms)).toLocaleString("de-DE");
}

function applyTheme(theme){
  document.documentElement.dataset.theme = theme || "standard";
}

let lastStatus = null;
let isAdmin = false;

async function refreshAll(){
  await loadStatus();
  await loadWasherSlots();
  await loadMyBookings();
}

async function loadStatus(){
  setStatus("Lade Status…");
  const data = await jget("/api/status");
  if(!data.ok){
    setStatus("Fehler beim Laden. (" + (data.http || "?") + ") " + (data.error || "") + " " + (data.body || ""));
    $("machinesOverview").innerHTML = "";
    $("washerSlotSelect").innerHTML = `<option value="">Keine Slots</option>`;
    return;
  }

  lastStatus = data;

  // Global Theme anwenden
  if(data.config?.uiTheme) applyTheme(data.config.uiTheme);

  // News
  const nt = String(data.newsText||"").trim();
  if(nt){
    $("news").style.display = "";
    $("news").textContent = nt;
  } else {
    $("news").style.display = "none";
  }

  renderMachinesOverview(data);
  setStatus("Bereit.");
}

function renderMachinesOverview(status){
  const box = $("machinesOverview");
  box.innerHTML = "";

  const machines = status.machines || [];
  const bookings = status.bookings || [];

  if(machines.length === 0){
    box.innerHTML = `<div class="machine-row"><div></div><div class="muted">Keine Maschinen</div><div></div></div>`;
    return;
  }

  const active = new Map();
  for(const b of bookings){
    if(b.status === "booked") active.set(`${b.type}:${b.machine}`, b);
  }

  machines.sort((a,b)=>{
    if(a.type !== b.type) return a.type.localeCompare(b.type);
    return Number(a.machine)-Number(b.machine);
  });

  for(const m of machines){
    const b = active.get(`${m.type}:${m.machine}`);

    let cls = "free";
    let text = "Frei";
    if(Number(m.defect) === 1){
      cls = "bad";
      text = "Defekt";
    } else if(b){
      cls = "busy";
      text = `Belegt bis ${fmtTime(b.end)} (Zimmer ${escapeHtml(b.room||"?")})`;
    }

    const row = document.createElement("div");
    row.className = "machine-row";
    row.innerHTML = `
      <div class="machine-status ${cls}"></div>
      <div>
        <div class="machine-title">${m.type==="washer" ? "Waschmaschine" : "Trockner"} ${m.machine}</div>
        <div class="machine-sub">${text}</div>
      </div>
      <div class="machine-actions"></div>
    `;

    // Trockner Schnellaktionen
    const act = row.querySelector(".machine-actions");
    if(m.type === "dryer" && Number(m.defect) === 0){
      if(!b){
        const btn = document.createElement("button");
        btn.textContent = "Buchen";
        btn.onclick = () => bookDryer(Number(m.machine));
        act.appendChild(btn);
      } else {
        const mine = (window.myBookingsCache||[]).find(x => x.type==="dryer" && Number(x.machine)===Number(m.machine) && x.status==="booked");
        if(mine){
          const btn = document.createElement("button");
          btn.textContent = "FERTIG";
          btn.onclick = () => finishDryer(mine.id);
          act.appendChild(btn);
        }
      }
    }

    box.appendChild(row);
  }
}

async function loadWasherSlots(){
  const sel = $("washerSlotSelect");
  sel.innerHTML = `<option value="">Bitte auswählen</option>`;

  if(!lastStatus?.ok){
    sel.innerHTML = `<option value="">Keine Slots</option>`;
    return;
  }

  const { room, pin, stationPin } = needAccess_();
  if(!room || !pin || !stationPin){
    sel.innerHTML = `<option value="">Bitte Zimmernummer, PIN und Stations-PIN eingeben</option>`;
    return;
  }

  const times = lastStatus.config?.washerTimes || [];
  if(!Array.isArray(times) || times.length === 0){
    sel.innerHTML = `<option value="">Keine Slots</option>`;
    return;
  }

  const now = new Date();
  const day = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0,0,0,0);

  for(const t of times){
    const [hh,mm] = String(t).split(":").map(Number);
    if(Number.isNaN(hh)||Number.isNaN(mm)) continue;
    const start = new Date(day.getTime());
    start.setHours(hh,mm,0,0);
    const end = new Date(start.getTime() + 2*60*60*1000);
    const opt = document.createElement("option");
    opt.value = String(start.getTime());
    opt.textContent = `${t} – ${fmtTime(end.getTime())}`;
    sel.appendChild(opt);
  }
}

async function loadMyBookings(){
  const box = $("myBookings");
  box.innerHTML = "";
  window.myBookingsCache = [];

  const { room, pin } = needAccess_();
  if(!room || !pin){
    box.innerHTML = `<div class="status">Bitte Zimmernummer und PIN eingeben.</div>`;
    return;
  }

  const { data } = await jpost("/api/my-bookings", { room, pin });
  if(!data.ok){
    box.innerHTML = `<div class="status">Fehler: ${escapeHtml(data.error||"")}</div>`;
    return;
  }

  window.myBookingsCache = data.bookings || [];

  for(const b of (data.bookings||[])){
    const isDefect = !!b.defect;
    const cls = isDefect ? "b-bad" : "b-busy";
    const card = document.createElement("div");
    card.className = `bcard ${cls}`;
    card.innerHTML = `
      <div class="b-top">
        <div>
          <div><b>${b.type==="washer" ? "Waschmaschine" : "Trockner"} ${b.machine}</b> ${isDefect ? '<span class="pill">Defekt</span>' : ''}</div>
          <div class="small muted">${fmtDateTime(b.start)} – ${fmtTime(b.end)}</div>
        </div>
        <div></div>
      </div>
    `;

    const btn = document.createElement("button");
    btn.textContent = b.canCancel ? "Stornieren" : "Storno nicht möglich";
    btn.disabled = !b.canCancel;
    btn.onclick = () => cancelBooking(b.id);
    card.appendChild(btn);

    box.appendChild(card);
  }

  if(lastStatus?.ok) renderMachinesOverview(lastStatus);
}

async function bookWasher(){
  const { room, pin, stationPin } = needAccess_();
  const startMs = Number($("washerSlotSelect").value||0);
  if(!startMs) return alert("Bitte Slot auswählen.");
  if(!room || !pin || !stationPin) return alert("Bitte Zimmernummer, PIN, Stations-PIN eingeben.");

  const { data } = await jpost("/api/washer/book", { room, pin, stationPin, start: startMs });
  if(!data.ok) return alert(data.error || "Fehler");
  alert("✅ Gebucht.");
  await refreshAll();
}

async function bookDryer(machine){
  const { room, pin, stationPin } = needAccess_();
  if(!room || !pin || !stationPin) return alert("Bitte Zimmernummer, PIN, Stations-PIN eingeben.");
  const { data } = await jpost("/api/dryer/book", { room, pin, stationPin, machine });
  if(!data.ok) return alert(data.error || "Fehler");
  alert("✅ Trockner gebucht.");
  await refreshAll();
}

async function finishDryer(bookingId){
  const { room, pin } = needAccess_();
  const { data } = await jpost("/api/dryer/finish", { room, pin, id: bookingId });
  if(!data.ok) return alert(data.error || "Fehler");
  alert("✅ Fertig gemeldet.");
  await refreshAll();
}

async function cancelBooking(id){
  const { room, pin } = needAccess_();
  const { data } = await jpost("/api/booking/cancel", { room, pin, id });
  if(!data.ok) return alert(data.error || "Fehler");
  alert("✅ Storniert.");
  await refreshAll();
}

async function userSetDefect(mode){
  const { room, pin, stationPin } = needAccess_();
  if(!room || !pin || !stationPin) return alert("Bitte Zimmernummer, PIN, Stations-PIN eingeben.");
  const type = $("defType").value;
  const machine = Number($("defMachine").value);
  const { data } = await jpost("/api/user/defect", { room, pin, stationPin, type, machine, mode });
  if(!data.ok) return alert(data.error || "Fehler");
  alert("✅ Gespeichert.");
  await refreshAll();
}

async function sendFeedback(){
  const { room, pin } = needAccess_();
  const msg = $("fb").value.trim();
  if(!room || !pin) return alert("Bitte Zimmernummer und PIN eingeben.");
  if(!msg) return alert("Bitte Text eingeben.");
  const { data } = await jpost("/api/feedback/send", { room, pin, message: msg });
  if(!data.ok) return alert(data.error || "Fehler");
  $("fb").value = "";
  alert("✅ Gesendet.");
}

/* ======= Admin ======= */
function toggleAdmin(){
  const p = $("adminPanel");
  p.style.display = (p.style.display==="none" ? "" : "none");
  if(p.style.display !== "none"){
    $("adminPw").focus();
  }
}
function adminPw_(){ return $("adminPw").value.trim(); }

window.addEventListener("load", () => {
  const apw = $("adminPw");
  apw.addEventListener("keydown", (e) => {
    if(e.key === "Enter"){
      e.preventDefault();
      adminUnlock();
    }
  });
});

async function adminUnlock(){
  const pw = adminPw_();
  if(!pw) return alert("Admin-Passwort fehlt.");

  const { data } = await jpost("/api/admin/has", { adminPassword: pw });
  if(!data.ok) return alert(data.error || "Fehler");
  if(!data.hasAdmin) return alert("Admin nicht freigeschaltet.");

  isAdmin = true;
  $("adminBody").style.display = "";

  await loadStatus();

  if(lastStatus?.config){
    $("uiTheme").value = lastStatus.config.uiTheme || "standard";
    $("dryerMinutes").value = String(lastStatus.config.dryerMinutes || 120);
    $("daysPast").value = String(lastStatus.config.daysPast || 1);
    $("daysFuture").value = String(lastStatus.config.daysFuture || 6);
    $("newsText").value = lastStatus.newsText || "";
    $("newsEnabled").checked = !!(lastStatus.newsText && String(lastStatus.newsText).trim());
  }

  buildTimeGrid(lastStatus?.config?.washerTimes || []);
}

function adminLogout(){
  isAdmin = false;
  $("adminPw").value = "";
  $("adminBody").style.display = "none";
  alert("✅ Ausgeloggt.");
}

function buildTimeGrid(selected){
  const grid = $("timeGrid");
  grid.innerHTML = "";
  const set = new Set((selected||[]).map(String));
  const times = ["06:00","08:00","10:00","12:00","14:00","16:00","18:00","20:00","22:00"];
  for(const t of times){
    const id = "t_"+t.replace(":","");
    const wrap = document.createElement("label");
    wrap.style.display = "flex";
    wrap.style.alignItems = "center";
    wrap.style.gap = "10px";
    wrap.style.fontWeight = "normal";
    wrap.innerHTML = `<input type="checkbox" id="${id}"> <span>${t}</span>`;
    grid.appendChild(wrap);
    $(id).checked = set.has(t);
  }
}

async function adminSaveTimes(){
  const pw = adminPw_();
  const times = [];
  const all = ["06:00","08:00","10:00","12:00","14:00","16:00","18:00","20:00","22:00"];
  for(const t of all){
    const id = "t_"+t.replace(":","");
    if($(id)?.checked) times.push(t);
  }
  const { data } = await jpost("/api/admin/set-washer-times", { adminPassword: pw, washerTimes: times });
  if(!data.ok) return alert(data.error || "Fehler");
  alert("✅ Gespeichert.");
  await refreshAll();
}

async function adminSaveDays(){
  const pw = adminPw_();
  const daysPast = Number($("daysPast").value||1);
  const daysFuture = Number($("daysFuture").value||6);
  const { data } = await jpost("/api/admin/set-days", { adminPassword: pw, daysPast, daysFuture });
  if(!data.ok) return alert(data.error || "Fehler");
  alert("✅ Gespeichert.");
  await refreshAll();
}

async function adminSaveNews(){
  const pw = adminPw_();
  const enabled = $("newsEnabled").checked;
  const text = enabled ? $("newsText").value : "";
  const { data } = await jpost("/api/admin/set-news", { adminPassword: pw, newsText: text });
  if(!data.ok) return alert(data.error || "Fehler");
  alert("✅ Gespeichert.");
  await refreshAll();
}

async function adminSaveUITheme(){
  const pw = adminPw_();
  const theme = $("uiTheme").value;
  const { data } = await jpost("/api/admin/set-ui-theme", { adminPassword: pw, theme });
  if(!data.ok) return alert(data.error || "Fehler");
  alert("✅ Gespeichert.");
  await refreshAll();
}

async function adminSaveDryerMinutes(){
  const pw = adminPw_();
  const minutes = Number($("dryerMinutes").value||120);
  const { data } = await jpost("/api/admin/set-dryer-minutes", { adminPassword: pw, minutes });
  if(!data.ok) return alert(data.error || "Fehler");
  alert("✅ Gespeichert.");
  await refreshAll();
}

/* Init */
refreshAll();
</script>
</body>
</html>
