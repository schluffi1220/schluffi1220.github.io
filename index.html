<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wasch-Portal</title>
  <style>
    :root{ --ok:#1b8f2a; --busy:#1e6bd6; --bad:#c40000; --bad2:#ff00aa; --line:#ddd; --muted:#666; }
    body{ font-family:Arial, sans-serif; margin:14px; max-width:980px; }
    h1{ margin:0 0 6px; } .sub{ color:var(--muted); margin:0 0 10px; }
    label{ font-weight:700; display:block; margin:10px 0 6px; }
    input,select,textarea{ width:100%; padding:10px; border:1px solid var(--line); border-radius:8px; font-size:16px; }
    button{ padding:10px 14px; border:1px solid var(--line); border-radius:10px; background:#f0f0f0; font-weight:800; cursor:pointer; }
    button.primary{ background:#111; color:#fff; border-color:#111; }
    .status{ padding:10px; border:1px solid var(--line); border-radius:10px; background:#fafafa; margin:10px 0; }
    .err{ background:#ffecec; border-color:#ffbdbd; }
    details summary{ cursor:pointer; font-weight:900; padding:8px 0; }
    .grid{ display:grid; grid-template-columns:1fr; gap:10px; }
    @media(min-width:700px){ .grid2{ grid-template-columns:1fr 1fr; } }
    .machine{ display:flex; justify-content:space-between; align-items:center; padding:10px; border:1px solid var(--line); border-radius:12px; }
    .left{ display:flex; gap:10px; align-items:flex-start; }
    .dot{ width:14px; height:14px; border-radius:999px; margin-top:4px; }
    .mname{ font-weight:900; } .mmeta{ color:var(--muted); font-size:14px; }
    .tag{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--line); margin-left:6px; }
    .topright{ float:right; }
    body.theme-highcontrast .dot.bad{ background:var(--bad2)!important; }
    .card{ border:1px solid var(--line); border-radius:16px; padding:12px; background:#f4f6f8; }
    .card.busy{ background:#e7f2ff; } .card.bad{ background:#ffe6e6; }
  </style>
</head>
<body class="theme-standard layout-list">
  <div class="topright"><a href="#admin">Admin</a></div>
  <h1>Wasch-Portal</h1>
  <div class="sub">Frontend (GitHub Pages) ↔ Backend (Cloudflare Worker + D1)</div>
  <div id="status" class="status">Bereit.</div>

  <h2>1) Zugang</h2>
  <div class="grid grid2">
    <div>
      <label>Zimmernummer</label>
      <input id="room" placeholder="z.B. 316" inputmode="numeric">
    </div>
    <div>
      <label>Persönlicher PIN</label>
      <input id="pin" placeholder="4-stellig" inputmode="numeric" type="password">
    </div>
  </div>

  <label>Stations-PIN (für Buchen & Defekt erforderlich)</label>
  <input id="stationPin" type="password" placeholder="Stations-PIN">

  <div style="margin-top:10px">
    <button class="primary" onclick="refreshAll()">Aktualisieren</button>
  </div>

  <h2>2) Maschinenübersicht</h2>
  <div id="machinesBox" class="grid"></div>

  <h2>3) Waschmaschinen-Slot buchen</h2>
  <label>Slot</label>
  <select id="slotSel"></select>
  <div style="margin-top:10px">
    <button class="primary" onclick="bookWasher()">Buchen</button>
  </div>

  <h2>4) Meine Buchungen</h2>
  <div style="margin-top:10px">
    <button onclick="loadMyBookings()">Meine Buchungen aktualisieren</button>
  </div>
  <div id="myBox" class="grid" style="margin-top:10px"></div>

  <details>
    <summary>Maschine als defekt melden / freigeben (mit Stations-PIN)</summary>
    <div class="grid grid2">
      <div>
        <label>Typ</label>
        <select id="defType">
          <option value="washer">Waschmaschine</option>
          <option value="dryer">Trockner</option>
        </select>
      </div>
      <div>
        <label>Maschine</label>
        <select id="defMachine">
          <option>1</option><option>2</option><option>3</option><option>4</option>
        </select>
      </div>
    </div>
    <div style="margin-top:10px">
      <button onclick="setDefect('defect')">Defekt melden</button>
      <button onclick="setDefect('free')">Freigeben</button>
    </div>
  </details>

  <details>
    <summary>Feedback / Problem melden</summary>
    <label>Nachricht</label>
    <textarea id="fbMsg" rows="4"></textarea>
    <div style="margin-top:10px">
      <button class="primary" onclick="sendFeedback()">Senden</button>
    </div>
  </details>

  <hr style="margin:20px 0">

  <h2 id="admin">Admin</h2>
  <div class="card">
    <label>Admin-Passwort</label>
    <input id="adminPw" type="password" placeholder="Admin-Passwort (Enter = Login)">
    <div style="margin-top:10px">
      <button class="primary" onclick="adminLogin()">Login</button>
    </div>
    <div id="adminState" style="margin-top:8px;color:var(--muted)"></div>
  </div>

  <div id="adminBox" style="display:none;margin-top:12px">
    <details open>
      <summary>UI & Zeiten</summary>

      <div class="grid grid2">
        <div>
          <label>Layout</label>
          <select id="uiLayout">
            <option value="list">Standard (Liste)</option>
            <option value="cards">Karten</option>
          </select>
        </div>
        <div>
          <label>Theme</label>
          <select id="uiTheme">
            <option value="standard">Standard</option>
            <option value="highcontrast">Highcontrast (Magenta)</option>
          </select>
        </div>
      </div>
      <div style="margin-top:10px">
        <button onclick="adminSaveUI()">UI speichern</button>
      </div>

      <label>Waschmaschinen-Zeiten (kommagetrennt HH:MM)</label>
      <input id="washerTimes" placeholder="06:00,08:00,10:00,...">
      <div style="margin-top:10px">
        <button onclick="adminSaveTimes()">Zeiten speichern</button>
      </div>

      <div class="grid grid2">
        <div>
          <label>Tage Vergangenheit</label>
          <input id="daysPast" inputmode="numeric">
        </div>
        <div>
          <label>Tage Zukunft</label>
          <input id="daysFuture" inputmode="numeric">
        </div>
      </div>
      <div style="margin-top:10px">
        <button onclick="adminSaveDays()">Tage-Fenster speichern</button>
      </div>

      <label>Trockner-Laufzeit</label>
      <select id="dryerMinutes">
        <option value="60">1 Stunde</option>
        <option value="90">1,5 Stunden</option>
        <option value="120">2 Stunden</option>
      </select>
      <div style="margin-top:10px">
        <button onclick="adminSaveDryerMinutes()">Trockner-Zeit speichern</button>
      </div>
    </details>

    <details>
      <summary>Stations-PIN & News</summary>
      <label>Stations-PIN</label>
      <input id="adminStationPin" type="password">
      <div style="margin-top:10px">
        <button onclick="adminSetStationPin()">Stations-PIN speichern</button>
      </div>

      <label>News</label>
      <textarea id="newsText" rows="3"></textarea>
      <label><input type="checkbox" id="newsEnabled"> Für User anzeigen</label>
      <div style="margin-top:10px">
        <button onclick="adminSaveNews()">Speichern</button>
      </div>
    </details>

    <details>
      <summary>Feedback (Admin)</summary>
      <div style="margin-top:10px">
        <button onclick="adminLoadFeedback()">Feedback laden</button>
      </div>
      <div id="fbList" class="grid" style="margin-top:10px"></div>
    </details>

    <details>
      <summary>Admin Passwort ändern</summary>
      <label>Neues Admin-Passwort (mind. 8 Zeichen)</label>
      <input id="newAdminPw" type="password">
      <div style="margin-top:10px">
        <button onclick="adminChangePw()">Ändern</button>
      </div>
    </details>
  </div>

<script>
  // ✅ DEIN WORKER HIER:
  const API_BASE = "https://snowy-breeze-54f8.schluffi1220.workers.dev";

  const $ = id => document.getElementById(id);
  function setStatus(msg, err=false){
    const el=$("status"); el.textContent=msg; el.className="status"+(err?" err":"");
  }
  async function jget(path){
    const r = await fetch(API_BASE+path, { cache:"no-store" });
    return r.json().catch(()=>({ok:false}));
  }
  async function jpost(path, body){
    const r = await fetch(API_BASE+path, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body||{})
    });
    return { r, data: await r.json().catch(()=>({ok:false})) };
  }

  let lastStatus=null;

  function applyTheme(cfg){
    document.body.classList.toggle("theme-highcontrast", (cfg?.uiTheme)==="highcontrast");
    document.body.classList.toggle("theme-standard", (cfg?.uiTheme)!=="highcontrast");
  }

  function fmtDT(ms){
    return new Date(ms).toLocaleString("de-DE",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});
  }
  function fmtTime(ms){
    return new Date(ms).toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"});
  }

  function needAccess(){
    return {
      room: $("room").value.trim(),
      pin: $("pin").value.trim(),
      stationPin: $("stationPin").value.trim()
    };
  }

  async function refreshAll(){
    setStatus("Lade…");
    const st = await jget("/api/status");
    if(!st.ok){ setStatus("Fehler beim Laden.", true); return; }
    lastStatus = st;
    applyTheme(st.config);

    renderMachines(st);
    await loadSlots();
    await loadMyBookings(true);
    setStatus("Bereit.");
  }

  function renderMachines(st){
    const box=$("machinesBox"); box.innerHTML="";
    const machines=st.machines||[];
    const bookings=st.bookings||[];
    const now=Date.now();

    const current=new Map();
    for(const b of bookings){
      if(b.status!=="booked") continue;
      if(b.start<=now && b.end>now) current.set(`${b.type}:${b.machine}`, b);
    }

    for(const m of machines){
      if(!m.enabled) continue;
      const b=current.get(`${m.type}:${m.machine}`);
      const isDef=!!m.defect;
      const isBusy=!!b;
      const dotColor = isDef ? "var(--bad)" : (isBusy ? "var(--busy)" : "var(--ok)");

      const wrap=document.createElement("div");
      wrap.className="machine";

      const left=document.createElement("div");
      left.className="left";

      const dot=document.createElement("div");
      dot.className="dot "+(isDef?"bad":"");
      dot.style.background=dotColor;

      const title=document.createElement("div");
      const name=(m.type==="dryer"?"Trockner":"Waschmaschine")+" "+m.machine;
      title.innerHTML = `
        <div class="mname">${name}${isDef?'<span class="tag">Defekt</span>':''}</div>
        <div class="mmeta">${isDef?"Defekt":(isBusy?`Belegt bis ${fmtTime(b.end)} (Zimmer ${b.room})`:"Frei")}</div>
      `;

      left.appendChild(dot); left.appendChild(title);

      const right=document.createElement("div");
      if(m.type==="dryer"){
        if(isBusy){
          const btn=document.createElement("button");
          btn.textContent="FERTIG";
          btn.onclick=()=>finishDryer(b.id);
          right.appendChild(btn);
        } else {
          const btn=document.createElement("button");
          btn.textContent="Buchen";
          btn.onclick=()=>bookDryer(m.machine);
          right.appendChild(btn);
        }
      }

      wrap.appendChild(left);
      wrap.appendChild(right);
      box.appendChild(wrap);
    }
  }

  async function loadSlots(){
    const { stationPin } = needAccess();
    const sel=$("slotSel"); sel.innerHTML="";
    if(!stationPin){ sel.innerHTML="<option>Bitte Stations-PIN eingeben</option>"; return; }

    const { data } = await jpost("/api/washer/free-slots", { stationPin });
    if(!data.ok){ sel.innerHTML="<option>Fehler beim Laden</option>"; return; }

    const slots=data.slots||[];
    if(!slots.length){ sel.innerHTML="<option>Keine Slots</option>"; return; }

    for(const s of slots){
      const opt=document.createElement("option");
      opt.value=String(s.start);
      opt.textContent=s.label;
      if(s.disabled) opt.disabled=true;
      sel.appendChild(opt);
    }
  }

  async function bookWasher(){
    const { room, pin, stationPin } = needAccess();
    const start=Number($("slotSel").value);
    if(!room||!pin||!stationPin){ alert("Zimmernummer, PIN und Stations-PIN eingeben."); return; }
    const { data } = await jpost("/api/washer/book", { room, pin, stationPin, start });
    if(!data.ok){ alert(data.error||"Fehler"); return; }
    alert("Gebucht.");
    await refreshAll();
  }

  async function bookDryer(machine){
    const { room, pin, stationPin } = needAccess();
    if(!room||!pin||!stationPin){ alert("Zimmernummer, PIN und Stations-PIN eingeben."); return; }
    const { data } = await jpost("/api/dryer/book", { room, pin, stationPin, machine });
    if(!data.ok){ alert(data.error||"Fehler"); return; }
    alert("Trockner gebucht.");
    await refreshAll();
  }

  async function finishDryer(id){
    const { pin } = needAccess();
    if(!pin){ alert("PIN fehlt."); return; }
    const { data } = await jpost("/api/dryer/finish", { id, pin });
    if(!data.ok){ alert(data.error||"Fehler"); return; }
    await refreshAll();
  }

  async function loadMyBookings(silent=false){
    const { room, pin } = needAccess();
    const box=$("myBox"); box.innerHTML="";
    if(!room||!pin){ if(!silent) box.innerHTML='<div class="status">Bitte Zimmernummer und PIN eingeben.</div>'; return; }

    const { data } = await jpost("/api/my-bookings", { room, pin });
    if(!data.ok){ box.innerHTML=`<div class="status err">Fehler: ${data.error||"internal_error"}</div>`; return; }

    const list=data.bookings||[];
    if(!list.length){ box.innerHTML='<div class="status">Keine Buchungen.</div>'; return; }

    for(const b of list){
      const isDef = (lastStatus?.machines||[]).some(m=>m.type===b.type && m.machine===b.machine && m.defect);
      const card=document.createElement("div");
      card.className="card "+(isDef?"bad":"");
      card.innerHTML = `
        <div style="font-weight:900">${b.type==="dryer"?"Trockner":"Waschmaschine"} ${b.machine} ${isDef?'<span class="tag">Defekt</span>':''}</div>
        <div style="color:var(--muted)">${fmtDT(b.start)} – ${fmtTime(b.end)}</div>
        <div style="margin-top:10px">
          ${b.type==="dryer"?`<button onclick="finishDryer('${b.id}')">FERTIG</button>`:""}
          <button onclick="cancelBooking('${b.id}')">Storno</button>
        </div>
      `;
      box.appendChild(card);
    }
  }

  async function cancelBooking(id){
    const { pin } = needAccess();
    if(!pin){ alert("PIN fehlt."); return; }
    const { data } = await jpost("/api/cancel", { id, pin });
    if(!data.ok){ alert(data.error||"Fehler"); return; }
    await refreshAll();
  }

  async function setDefect(action){
    const { room, stationPin } = needAccess();
    const type=$("defType").value;
    const machine=Number($("defMachine").value);
    if(!room||!stationPin){ alert("Zimmer + Stations-PIN erforderlich."); return; }
    const { data } = await jpost("/api/user/set-defect", { room, stationPin, type, machine, action });
    if(!data.ok){ alert(data.error||"Fehler"); return; }
    await refreshAll();
  }

  async function sendFeedback(){
    const room=$("room").value.trim();
    const msg=$("fbMsg").value.trim();
    if(!room||!msg){ alert("Zimmernummer + Nachricht nötig."); return; }
    const { data } = await jpost("/api/feedback", { room, message: msg });
    if(!data.ok){ alert(data.error||"Fehler"); return; }
    $("fbMsg").value="";
    alert("Feedback gesendet.");
  }

  // ADMIN
  $("adminPw").addEventListener("keydown", e => { if(e.key==="Enter") adminLogin(); });

  function confirm2(txt){
    if(!confirm(txt)) return false;
    alert("Wird gespeichert…");
    return true;
  }

  async function adminLogin(){
    const pw=$("adminPw").value.trim();
    const st=await jget("/api/admin/state");
    if(!st.ok){ $("adminState").textContent="Admin-State nicht erreichbar"; return; }

    if(!st.hasAdmin){
      const init = prompt("Kein Admin gesetzt. Neues Admin-Passwort (min 8 Zeichen):");
      if(!init) return;
      const r = await jpost("/api/admin/set-initial-password", { newPassword: init });
      if(!r.data.ok){ alert(r.data.error||"Fehler"); return; }
      $("adminPw").value = init;
    }

    const r = await jpost("/api/admin/login", { adminPassword: pw });
    if(!r.data.ok){ alert("Login fehlgeschlagen."); return; }

    $("adminBox").style.display="block";
    $("adminState").textContent="Eingeloggt.";

    const s = await jget("/api/status");
    if(s.ok){
      $("washerTimes").value=(s.config?.washerTimes||[]).join(",");
      $("daysPast").value=s.config?.daysPast ?? 1;
      $("daysFuture").value=s.config?.daysFuture ?? 6;
      $("dryerMinutes").value=String(s.config?.dryerMinutes ?? 120);
      $("uiLayout").value=s.config?.uiLayout ?? "list";
      $("uiTheme").value=s.config?.uiTheme ?? "standard";
      applyTheme(s.config);
    }
  }

  async function adminSaveUI(){
    if(!confirm2("UI wirklich speichern?")) return;
    const pw=$("adminPw").value.trim();
    const uiLayout=$("uiLayout").value;
    const uiTheme=$("uiTheme").value;
    const r=await jpost("/api/admin/set-ui", { adminPassword: pw, uiLayout, uiTheme });
    if(!r.data.ok){ alert(r.data.error||"Fehler"); return; }
    alert("Gespeichert.");
    await refreshAll();
  }

  async function adminSaveTimes(){
    if(!confirm2("Zeiten wirklich speichern?")) return;
    const pw=$("adminPw").value.trim();
    const times=$("washerTimes").value.split(",").map(s=>s.trim()).filter(Boolean);
    const r=await jpost("/api/admin/set-washer-times", { adminPassword: pw, times });
    if(!r.data.ok){ alert(r.data.error||"Fehler"); return; }
    alert("Gespeichert.");
    await refreshAll();
  }

  async function adminSaveDays(){
    if(!confirm2("Tage-Fenster wirklich speichern?")) return;
    const pw=$("adminPw").value.trim();
    const daysPast=Number($("daysPast").value);
    const daysFuture=Number($("daysFuture").value);
    const r=await jpost("/api/admin/set-days-window", { adminPassword: pw, daysPast, daysFuture });
    if(!r.data.ok){ alert(r.data.error||"Fehler"); return; }
    alert("Gespeichert.");
    await refreshAll();
  }

  async function adminSaveDryerMinutes(){
    if(!confirm2("Trocknerzeit speichern?")) return;
    const pw=$("adminPw").value.trim();
    const dryerMinutes=Number($("dryerMinutes").value);
    const r=await jpost("/api/admin/set-dryer-minutes", { adminPassword: pw, dryerMinutes });
    if(!r.data.ok){ alert(r.data.error||"Fehler"); return; }
    alert("Gespeichert.");
    await refreshAll();
  }

  async function adminSetStationPin(){
    if(!confirm2("Stations-PIN speichern?")) return;
    const pw=$("adminPw").value.trim();
    const stationPin=$("adminStationPin").value.trim();
    const r=await jpost("/api/admin/set-station-pin", { adminPassword: pw, stationPin });
    if(!r.data.ok){ alert(r.data.error||"Fehler"); return; }
    alert("Gespeichert.");
  }

  async function adminSaveNews(){
    if(!confirm2("News speichern?")) return;
    const pw=$("adminPw").value.trim();
    const text=$("newsText").value;
    const enabled=$("newsEnabled").checked;
    const r=await jpost("/api/admin/news/set", { adminPassword: pw, text, enabled });
    if(!r.data.ok){ alert(r.data.error||"Fehler"); return; }
    alert("Gespeichert.");
    await refreshAll();
  }

  async function adminLoadFeedback(){
    const pw=$("adminPw").value.trim();
    const r=await jpost("/api/admin/feedback/list", { adminPassword: pw });
    if(!r.data.ok){ alert(r.data.error||"Fehler"); return; }

    const box=$("fbList"); box.innerHTML="";
    const items=r.data.items||[];
    if(!items.length){ box.innerHTML='<div class="status">Kein Feedback.</div>'; return; }

    for(const f of items){
      const div=document.createElement("div");
      div.className="card";
      div.innerHTML=`
        <div style="font-weight:900">Zimmer ${f.room} <span style="color:var(--muted)">(${fmtDT(f.createdAt)})</span></div>
        <div style="margin-top:6px">${escapeHtml(f.message||"")}</div>
        <label style="margin-top:10px">Antwort</label>
        <textarea id="rep-${f.id}" rows="2">${escapeHtml(f.adminReply||"")}</textarea>
        <label><input type="checkbox" id="vis-${f.id}" ${f.visibleToUser? "checked":""}> Für User sichtbar</label>
        <div style="margin-top:10px">
          <button onclick="adminReply('${f.id}')">Antwort speichern</button>
        </div>
      `;
      box.appendChild(div);
    }
  }

  async function adminReply(id){
    if(!confirm2("Antwort speichern?")) return;
    const pw=$("adminPw").value.trim();
    const reply=$("rep-"+id).value;
    const visibleToUser=$("vis-"+id).checked;
    const r=await jpost("/api/admin/feedback/reply", { adminPassword: pw, id, reply, visibleToUser });
    if(!r.data.ok){ alert(r.data.error||"Fehler"); return; }
    alert("Gespeichert.");
  }

  async function adminChangePw(){
    if(!confirm2("Admin-Passwort ändern?")) return;
    const pw=$("adminPw").value.trim();
    const newPassword=$("newAdminPw").value.trim();
    const r=await jpost("/api/admin/change-password", { adminPassword: pw, newPassword });
    if(!r.data.ok){ alert(r.data.error||"Fehler"); return; }
    alert("Geändert.");
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
  }

  refreshAll();
</script>
</body>
</html>
