<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Wasch-Portal</title>
<style>
  :root{
    --dot-free:#2e7d32;
    --dot-busy:#1565c0;
    --dot-bad:#c62828;     /* Standard rot */
  }
  body.theme-highcontrast{
    --dot-bad:#d81b60;     /* High-Contrast Magenta */
  }

  body { font-family: Arial, sans-serif; margin: 14px; max-width: 980px; }
  h1 { margin: 0 0 6px; }
  h2 { margin: 14px 0 8px; }
  label { font-weight: bold; display:block; margin-top: 10px; }
  input, select, textarea {
    width: 100%; padding: 10px; margin-top: 6px; box-sizing: border-box;
    font-size: 16px; border-radius: 10px; border: 1px solid #ddd;
  }
  button {
    width: 100%; padding: 11px; margin-top: 8px; cursor: pointer;
    font-size: 16px; border-radius: 10px; border: 1px solid #ddd; background: #f2f2f2;
  }
  button.smallbtn { width:auto; padding:8px 10px; margin: 6px 6px 0 0; font-size: 14px; }
  .grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
  @media (min-width: 760px){ .grid2 { grid-template-columns: 1fr 1fr; } }
  .card { border: 1px solid #ddd; border-radius: 12px; padding: 12px; }
  .free { background: #e8f5e9; }
  .busy { background: #e3f2fd; }
  .bad  { background: #ffebee; }
  .disabled { opacity: 0.7; }
  .muted { opacity: 0.85; }
  .small { font-size: 13px; opacity: 0.9; }
  .status { margin-top: 10px; padding: 10px; border-radius: 10px; border: 1px solid #ddd; background: #fafafa; }
  .topbar { display:flex; align-items:center; justify-content:space-between; gap: 10px; }
  .link { font-size: 14px; text-decoration: underline; cursor: pointer; opacity: 0.85; user-select:none; }
  .row2 { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }

  details summary {
    display: block;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 12px;
    background: #f7f7f7;
    cursor: pointer;
    user-select: none;
  }
  details[open] summary { border-bottom-left-radius: 0; border-bottom-right-radius: 0; }
  details summary::-webkit-details-marker { display:none; }

  .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; border:1px solid #ddd; font-size: 12px; margin-left: 6px; background: #fff; }
  .pill.red { background:#ffebee; }
  .pill.blue { background:#e3f2fd; }
  .pill.green { background:#e8f5e9; }

  /* Variante B: kompakte Maschinenliste */
  .machine-row {
    display: grid;
    grid-template-columns: 26px 1fr auto;
    gap: 10px;
    align-items: center;
    padding: 10px;
    border-bottom: 1px solid #e0e0e0;
  }
  .machine-row:last-child { border-bottom: none; }
  .machine-status { width: 16px; height: 16px; border-radius: 50%; outline: 2px solid rgba(0,0,0,0.06); }
  .machine-status.free { background: var(--dot-free); }
  .machine-status.busy { background: var(--dot-busy); }
  .machine-status.bad  { background: var(--dot-bad); outline: 2px solid rgba(0,0,0,0.10); }
  .machine-title { font-weight: bold; }
  .machine-sub { font-size: 13px; opacity: 0.85; }
  .machine-actions button { width:auto; padding: 6px 10px; font-size: 14px; margin-top:0; }
</style>
</head>
<body>

<div class="topbar">
  <div>
    <h1>Wasch-Portal</h1>
    <div class="small muted" id="subline">GitHub Pages + Cloudflare Worker (D1)</div>
  </div>
  <div class="link" onclick="toggleAdmin()">Admin</div>
</div>

<details id="newsDetails" style="margin-top:10px; display:none;">
  <summary><b>Neu in der Version</b> <span id="newsBadge" class="pill" style="display:none;">NEU</span></summary>
  <div class="card" style="border-top-left-radius:0;border-top-right-radius:0;">
    <div id="newsTextBox" class="small"></div>
  </div>
</details>

<div id="status" class="status">Lade‚Ä¶</div>

<h2>1) Zugang</h2>
<label>Zimmernummer</label>
<input id="room" placeholder="0 - 400" inputmode="numeric" />

<label>Pers√∂nlicher PIN</label>
<input id="pin" type="password" placeholder="PIN" inputmode="numeric" />

<label>Stations-PIN (f√ºr Buchen / Defekt / Chat)</label>
<input id="stationPin" type="password" placeholder="Stations-PIN" inputmode="numeric" />

<button onclick="refreshAll()">Aktualisieren</button>

<h2>2) Waschmaschinen-Slot buchen</h2>
<label>Slot ausw√§hlen (auch belegte sind sichtbar)</label>
<select id="washerSlotSelect">
  <option value="">Bitte ausw√§hlen</option>
</select>
<button onclick="bookWasher()">Buchen</button>

<h2>Maschinen√ºbersicht</h2>
<div id="machinesOverview" class="card"></div>

<h2>Meine gebuchten Maschinen</h2>
<button onclick="loadMyBookings()">Meine Buchungen aktualisieren</button>
<div id="myBookings" class="grid"></div>

<details style="margin-top:14px;">
  <summary><b>Maschine als defekt melden / freigeben</b></summary>
  <div class="card" style="border-top-left-radius:0;border-top-right-radius:0;">
    <div class="row2">
      <div>
        <label>Ger√§t</label>
        <select id="defType">
          <option value="washer">Waschmaschine</option>
          <option value="dryer">Trockner</option>
        </select>
      </div>
      <div>
        <label>Nummer</label>
        <select id="defMachine">
          <option value="1">1</option><option value="2">2</option>
          <option value="3">3</option><option value="4">4</option>
        </select>
      </div>
    </div>
    <button onclick="userSetDefect('defect')">Als defekt melden</button>
    <button onclick="userSetDefect('free')">Freigeben</button>
    <div class="small muted">Hinweis: Bitte zus√§tzlich der Rezeption Bescheid geben.</div>
  </div>
</details>

<h2>Feedback / Chat</h2>
<div class="card">
  <div class="small muted">Zimmer + PIN erforderlich. Admin kann Antworten ‚Äúsichtbar f√ºr User‚Äù freigeben.</div>
  <div style="margin-top:10px;">
    <button class="smallbtn" onclick="loadUserChat()">Chat laden</button>
    <button class="smallbtn" onclick="sendUserChat()">Senden</button>
  </div>
  <textarea id="chatText" rows="3" placeholder="Nachricht an Admin..."></textarea>
  <div id="chatList" class="grid" style="margin-top:10px;"></div>
</div>

<div id="adminPanel" style="display:none; margin-top: 16px; border-top:1px solid #ddd; padding-top: 12px;">
  <h2>Admin</h2>

  <label>Admin-Passwort</label>
  <input id="adminPw" type="password" placeholder="Admin-Passwort" autocomplete="current-password" />
  <div class="row2">
    <button onclick="adminUnlock()">Login</button>
    <button onclick="adminLogout()">Logout</button>
  </div>

  <div id="adminBody" style="display:none;">

    <details open>
      <summary><b>Design & Trocknerlaufzeit</b></summary>
      <div class="card" style="border-top-left-radius:0;border-top-right-radius:0;">
        <label>Design</label>
        <select id="uiTheme">
          <option value="standard">Standard</option>
          <option value="highcontrast">High-Contrast (Magenta)</option>
        </select>
        <button onclick="adminSaveTheme()">Speichern</button>

        <hr style="border:none;border-top:1px solid #eee;margin:12px 0;">

        <label>Trocknerlaufzeit (nur f√ºr neue Buchungen)</label>
        <select id="dryerMinutes">
          <option value="60">1 Stunde</option>
          <option value="90">1,5 Stunden</option>
          <option value="120">2 Stunden</option>
        </select>
        <button onclick="adminSaveDryerMinutes()">Speichern</button>
      </div>
    </details>

    <details open>
      <summary><b>Stations-PIN</b></summary>
      <div class="card" style="border-top-left-radius:0;border-top-right-radius:0;">
        <label>Stations-PIN setzen/√§ndern</label>
        <input id="adminStationPin" type="password" placeholder="Stations-PIN" inputmode="numeric" />
        <button onclick="adminSetStationPin()">Speichern</button>
      </div>
    </details>

    <details open>
      <summary><b>Tage-Fenster + Cleanup</b></summary>
      <div class="card" style="border-top-left-radius:0;border-top-right-radius:0;">
        <div class="row2">
          <div>
            <label>Vergangene Tage anzeigen</label>
            <input id="daysPast" inputmode="numeric" placeholder="z. B. 1" />
          </div>
          <div>
            <label>Folgende Tage anzeigen</label>
            <input id="daysFuture" inputmode="numeric" placeholder="z. B. 6" />
          </div>
        </div>
        <div class="small muted">Alles, was √§lter als ‚ÄúVergangene Tage‚Äù ist, wird automatisch gel√∂scht (Buchungen + Log).</div>
        <button onclick="adminSaveDays()">Speichern</button>
      </div>
    </details>

    <details open>
      <summary><b>Waschmaschinen Slotzeiten</b></summary>
      <div class="card" style="border-top-left-radius:0;border-top-right-radius:0;">
        <div class="small muted">Haken setzen ‚Üí diese Zeiten werden als Slots verwendet.</div>
        <div id="timeGrid" class="grid grid2" style="margin-top:10px;"></div>
        <button onclick="adminSaveTimes()">Speichern</button>
      </div>
    </details>

    <details open>
      <summary><b>Maschinen freigeben / sperren / defekt</b></summary>
      <div class="card" style="border-top-left-radius:0;border-top-right-radius:0;">
        <div id="adminMachines" class="grid grid2"></div>
      </div>
    </details>

    <details>
      <summary><b>User d√ºrfen defekt melden?</b></summary>
      <div class="card" style="border-top-left-radius:0;border-top-right-radius:0;">
        <label><input type="checkbox" id="udEnabled"> User-Defektmeldungen aktiv</label>
        <div id="udGrid" class="grid grid2" style="margin-top:10px;"></div>
        <button onclick="adminSaveUserDefect()">Speichern</button>
      </div>
    </details>

    <details>
      <summary><b>Neu in der Version</b></summary>
      <div class="card" style="border-top-left-radius:0;border-top-right-radius:0;">
        <label>Text</label>
        <textarea id="newsText" rows="4" placeholder="Neue Hinweise f√ºr User..."></textarea>
        <label><input type="checkbox" id="newsEnabled"> F√ºr User anzeigen</label>
        <button onclick="adminSaveNews()">Speichern</button>
      </div>
    </details>

    <details open>
      <summary><b>Chat / Feedback (Admin)</b> <span id="adminChatBadge" class="pill" style="display:none;">NEU</span></summary>
      <div class="card" style="border-top-left-radius:0;border-top-right-radius:0;">
        <button class="smallbtn" onclick="adminLoadRooms()">Zimmerliste laden</button>
        <div id="adminRooms" class="grid grid2" style="margin-top:10px;"></div>

        <div id="adminChatBox" style="display:none; margin-top:10px;">
          <h3 style="margin: 10px 0 6px;">Chat mit Zimmer <span id="adminRoomTitle"></span></h3>
          <div class="row2">
            <button onclick="adminLoadChat()">Chat aktualisieren</button>
            <button onclick="adminSendChat()">Antwort senden</button>
          </div>
          <textarea id="adminChatText" rows="3" placeholder="Antwort..."></textarea>
          <label class="small"><input type="checkbox" id="adminVisibleToUser" checked> sichtbar f√ºr User</label>
          <div id="adminChatList" class="grid" style="margin-top:10px;"></div>
        </div>
      </div>
    </details>

    <details>
      <summary><b>Log (Buchungen / Storno / Defekt / Admin-Aktionen)</b></summary>
      <div class="card" style="border-top-left-radius:0;border-top-right-radius:0;">
        <button onclick="adminLoadLog()">Log laden</button>
        <div id="adminLog" class="grid" style="margin-top:10px;"></div>
      </div>
    </details>

    <details>
      <summary><b>Admin-Passwort √§ndern</b></summary>
      <div class="card" style="border-top-left-radius:0;border-top-right-radius:0;">
        <label>Neues Admin-Passwort (mind. 8 Zeichen)</label>
        <input id="newAdminPw" type="password" placeholder="Neues Passwort" autocomplete="new-password" />
        <button onclick="adminChangePw()">Passwort √§ndern</button>
      </div>
    </details>

  </div>
</div>

<script>
const API_BASE = "https://snowy-breeze-54f8.schluffi1220.workers.dev";

const $ = (id) => document.getElementById(id);
function apiUrl(path){ if(!path.startsWith("/")) path="/"+path; return API_BASE + path; }
function setStatus(msg){ $("status").textContent = msg; }

async function jget(path){
  const r = await fetch(apiUrl(path), { cache:"no-store" });
  return await r.json().catch(()=>({}));
}
async function jpost(path, body){
  const r = await fetch(apiUrl(path), {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body||{})
  });
  const data = await r.json().catch(()=>({}));
  return { data, status: r.status };
}
function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
}
function fmtTime(ms){
  return new Date(Number(ms)).toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"});
}
function fmtDate(ms){
  return new Date(Number(ms)).toLocaleDateString("de-DE");
}
function formatLogDetails(s){
  s = String(s||"");
  s = s.replace(/start=(\d+)/g, (_,ms)=>"start="+new Date(Number(ms)).toLocaleString("de-DE"));
  s = s.replace(/end=(\d+)/g, (_,ms)=>"end="+new Date(Number(ms)).toLocaleString("de-DE"));
  return escapeHtml(s);
}

function needAccess_(){
  return {
    room: $("room").value.trim(),
    pin: $("pin").value.trim(),
    stationPin: $("stationPin").value.trim()
  };
}
function adminPw_(){ return $("adminPw").value.trim(); }

async function confirmAndRun(msg, fn){
  if(!confirm(msg)) return null;
  const r = await fn();
  if(r?.ok) alert("‚úÖ Gespeichert.");
  else alert("‚ùå " + (r?.error || "Fehler"));
  return r;
}

let lastStatus = null;
let myBookingsCache = [];
let userChatPopupShown = false;
let adminSelectedRoom = null;
let adminChatPopupShown = false;

/* Theme apply */
function applyTheme(theme){
  document.body.classList.toggle("theme-highcontrast", theme === "highcontrast");
}

/* NEWS */
function updateNewsUI(newsText){
  const details = $("newsDetails");
  const badge = $("newsBadge");
  const box = $("newsTextBox");

  if(!newsText || !String(newsText).trim()){
    details.style.display = "none";
    return;
  }
  details.style.display = "block";
  box.textContent = newsText;

  const hash = "n:" + newsText.length + ":" + newsText.slice(0,40);
  const last = localStorage.getItem("lastNewsHash") || "";
  const isNew = hash !== last;

  badge.style.display = isNew ? "inline-block" : "none";
  details.open = isNew;
  if(isNew) localStorage.setItem("lastNewsHash", hash);
}

/* Maschinen√ºbersicht (Variante B) */
function renderMachinesOverview(status){
  const box = $("machinesOverview");
  box.innerHTML = "";

  const machines = status.machines || [];
  const bookings = status.bookings || [];
  const active = new Map();
  for(const b of bookings) active.set(`${b.type}:${b.machine}`, b);

  machines.sort((a,b)=>{
    if(a.type !== b.type) return a.type.localeCompare(b.type);
    return Number(a.machine) - Number(b.machine);
  });

  for(const m of machines){
    const key = `${m.type}:${m.machine}`;
    const b = active.get(key);

    let statusClass = "free";
    let statusText = "Frei";

    const enabled = Number(m.enabled) === 1;
    const defect = Number(m.defect) === 1;

    if(defect){
      statusClass = "bad";
      statusText = "Defekt";
    } else if(!enabled){
      statusClass = "bad";
      statusText = "Gesperrt";
    } else if(b){
      statusClass = "busy";
      statusText = `Belegt bis ${fmtTime(b.end)} (Zimmer ${escapeHtml(b.room||"?")})`;
    }

    const row = document.createElement("div");
    row.className = "machine-row";
    row.innerHTML = `
      <div class="machine-status ${statusClass}"></div>
      <div>
        <div class="machine-title">${m.type === "washer" ? "Waschmaschine" : "Trockner"} ${m.machine}</div>
        <div class="machine-sub">${statusText}</div>
      </div>
      <div class="machine-actions"></div>
    `;

    const actions = row.querySelector(".machine-actions");

    // Aktionen nur f√ºr Trockner
    if(m.type === "dryer" && enabled && !defect){
      if(!b){
        const btn = document.createElement("button");
        btn.textContent = "Buchen";
        btn.onclick = () => bookDryer(Number(m.machine));
        actions.appendChild(btn);
      } else {
        const mine = myBookingsCache.find(x => x.type==="dryer" && Number(x.machine)===Number(m.machine));
        if(mine){
          const btn = document.createElement("button");
          btn.textContent = "FERTIG";
          btn.onclick = () => finishDryer(mine.id);
          actions.appendChild(btn);
        }
      }
    }

    box.appendChild(row);
  }
}

/* Slots */
async function loadWasherSlots(){
  const sel = $("washerSlotSelect");
  sel.innerHTML = `<option value="">Bitte ausw√§hlen</option>`;

  const { stationPin } = needAccess_();
  if(!stationPin){
    sel.innerHTML = `<option value="">Bitte Stations-PIN eingeben</option>`;
    return;
  }

  const { data } = await jpost("/api/washer/free-slots", { stationPin });
  if(!data.ok){
    sel.innerHTML = `<option value="">${data.error || "Keine Slots"}</option>`;
    return;
  }

  const slots = data.slots || [];
  if(slots.length===0){
    sel.innerHTML = `<option value="">Keine Slots</option>`;
    return;
  }

  for(const s of slots){
    const opt = document.createElement("option");
    opt.value = JSON.stringify({ machine:s.machine, start:s.start, end:s.end, bookable:s.bookable });
    opt.textContent = s.bookable ? s.label : `${s.label} (${s.reason})`;
    if(!s.bookable) opt.disabled = true;
    sel.appendChild(opt);
  }
}

function bookingConfirmText_(){
  return "Buchung best√§tigen?\n\nWenn du deine gebuchte Zeit √ºberschreitest, ist der n√§chste berechtigt, die W√§sche vorsichtig in den Korb zu r√§umen und auf oder neben die Maschine zu stellen.";
}

async function bookWasher(){
  const { room, pin, stationPin } = needAccess_();
  if(!room || !pin || !stationPin) return alert("Bitte Zimmernummer, PIN und Stations-PIN eingeben.");

  const val = $("washerSlotSelect").value;
  if(!val) return alert("Bitte Slot ausw√§hlen.");
  const slot = JSON.parse(val);
  if(!slot.bookable) return alert("Dieser Slot ist nicht buchbar.");

  if(!confirm(bookingConfirmText_())) return;

  const { data } = await jpost("/api/washer/book", {
    room, pin, stationPin,
    machine: slot.machine,
    start: slot.start,
    end: slot.end
  });

  if(data.ok) alert("Buchung erfolgreich.");
  else alert(data.error || "Fehler beim Buchen.");
  await refreshAll();
}

async function bookDryer(machine){
  const { room, pin, stationPin } = needAccess_();
  if(!room || !pin || !stationPin) return alert("Bitte Zimmernummer, PIN und Stations-PIN eingeben.");
  if(!confirm("Trockner buchen?")) return;

  const { data } = await jpost("/api/dryer/book", { room, pin, stationPin, machine });
  if(data.ok) alert("Trockner gebucht.");
  else alert(data.error || "Fehler.");
  await refreshAll();
}

/* My bookings */
async function loadMyBookings(){
  const box = $("myBookings");
  box.innerHTML = "";

  const { room, pin } = needAccess_();
  if(!room || !pin){
    myBookingsCache = [];
    box.innerHTML = `<div class="card muted">Bitte Zimmernummer und PIN eingeben.</div>`;
    return;
  }

  const { data } = await jpost("/api/my-bookings", { room, pin });
  if(!data.ok){
    myBookingsCache = [];
    box.innerHTML = `<div class="card bad">${data.error || "Fehler"}</div>`;
    return;
  }

  const list = data.bookings || [];
  myBookingsCache = list;

  if(list.length===0){
    box.innerHTML = `<div class="card muted">Keine Buchungen gefunden.</div>`;
    return;
  }

  const defectMap = new Map();
  if(lastStatus?.machines){
    for(const m of lastStatus.machines){
      defectMap.set(`${m.type}:${m.machine}`, Number(m.defect)===1);
    }
  }

  for(const b of list){
    const isDefect = defectMap.get(`${b.type}:${b.machine}`) === true;
    const card = document.createElement("div");
    card.className = `card ${isDefect ? "bad" : "busy"}`;

    const title = (b.type==="washer" ? "Waschmaschine " : "Trockner ") + b.machine;
    const line = (b.type==="washer")
      ? `${fmtDate(b.start)} ${fmtTime(b.start)} ‚Äì ${fmtTime(b.end)}`
      : `bis ${fmtTime(b.end)}`;

    card.innerHTML = `<b>${title}</b>${isDefect ? ' <span class="pill red">Defekt</span>' : ""}<br><div class="small">${line}</div>`;

    if(b.type==="washer"){
      const btn = document.createElement("button");
      btn.textContent = b.canCancel ? "Stornieren" : "Storno nicht m√∂glich";
      btn.disabled = !b.canCancel;
      btn.onclick = ()=>cancelBooking(b.id);
      card.appendChild(btn);
    } else {
      const btn = document.createElement("button");
      btn.textContent = b.canFinish ? "FERTIG" : "Abgelaufen";
      btn.disabled = !b.canFinish;
      btn.onclick = ()=>finishDryer(b.id);
      card.appendChild(btn);
    }

    box.appendChild(card);
  }
}

async function cancelBooking(id){
  const { pin } = needAccess_();
  if(!pin) return alert("PIN fehlt.");
  if(!confirm("Buchung wirklich stornieren?")) return;

  const { data } = await jpost("/api/cancel", { id, pin });
  if(data.ok) alert("Storniert.");
  else alert(data.error || "Fehler.");
  await refreshAll();
}

async function finishDryer(id){
  const { pin } = needAccess_();
  if(!pin) return alert("PIN fehlt.");
  if(!confirm("Trockner als FERTIG markieren?")) return;

  const { data } = await jpost("/api/dryer/finish", { id, pin });
  if(data.ok) alert("Erledigt.");
  else alert(data.error || "Fehler.");
  await refreshAll();
}

/* Defect */
async function userSetDefect(action){
  const { room, stationPin } = needAccess_();
  const type = $("defType").value;
  const machine = Number($("defMachine").value);

  if(!stationPin) return alert("Stations-PIN fehlt.");
  const ok = confirm(action==="defect"
    ? "Ger√§t wirklich als DEFekt melden?\n\nBitte zus√§tzlich der Rezeption Bescheid geben."
    : "Ger√§t wirklich FREIGEBEN?");
  if(!ok) return;

  const { data } = await jpost("/api/user/set-defect", { stationPin, room, type, machine, action });
  if(data.ok) alert("Gespeichert.");
  else alert(data.error || "Fehler.");
  await refreshAll();
}

/* Chat user */
async function checkUserChatUnread(){
  const { room, pin } = needAccess_();
  if(!room || !pin) return;

  const { data } = await jpost("/api/chat/user/unread-count", { room, pin });
  if(!data.ok) return;

  const c = Number(data.count || 0);
  if(c > 0){
    if(!userChatPopupShown){
      userChatPopupShown = true;
      alert("üì© Neue Nachricht vom Admin im Chat.");
    }
    await loadUserChat();
  }
}

async function loadUserChat(){
  const { room, pin } = needAccess_();
  if(!room || !pin) return alert("Bitte Zimmernummer + PIN eingeben.");
  const { data } = await jpost("/api/chat/user/list", { room, pin });
  if(!data.ok) return alert(data.error || "Fehler");

  const box = $("chatList");
  box.innerHTML = "";
  for(const m of data.messages || []){
    const c = document.createElement("div");
    const isAdmin = m.sender === "admin";
    c.className = `card ${isAdmin ? "busy" : "free"}`;
    c.innerHTML = `<b>${isAdmin ? "Admin" : "Du"}</b> <span class="small muted">${new Date(m.createdAt).toLocaleString("de-DE")}</span><br>${escapeHtml(m.body)}`;
    box.appendChild(c);
  }
}

async function sendUserChat(){
  const { room, pin, stationPin } = needAccess_();
  const text = $("chatText").value.trim();
  if(!room || !pin) return alert("Zimmernummer + PIN fehlen.");
  if(!stationPin) return alert("Stations-PIN fehlt (f√ºr Chat).");
  if(!text) return alert("Text fehlt.");

  const { data } = await jpost("/api/chat/user/send", { room, pin, stationPin, text });
  if(!data.ok) return alert(data.error || "Fehler");

  $("chatText").value = "";
  await loadUserChat();
}

/* Admin show/hide */
function toggleAdmin(){
  const p = $("adminPanel");
  p.style.display = (p.style.display==="none" ? "block" : "none");
}
function adminLogout(){
  $("adminPw").value = "";
  $("adminBody").style.display = "none";
  $("adminChatBox").style.display = "none";
  alert("Admin ausgeloggt.");
}

/* Admin unlock + load state */
async function adminUnlock(){
  const pw = adminPw_();
  if(!pw) return alert("Admin-Passwort eingeben.");

  const st = await jget("/api/admin/state");
  if(!st.ok) return alert(st.error || "Fehler");

  if(!st.hasAdmin){
    const init = prompt("Admin-Passwort ist noch nicht gesetzt.\nInitiales Passwort (mind. 8 Zeichen) setzen:");
    if(!init || init.length < 8) return alert("Zu kurz.");
    const { data } = await jpost("/api/admin/set-initial-password", { newPassword: init });
    if(!data.ok) return alert(data.error || "Fehler");
    $("adminPw").value = init;
  }

  $("adminBody").style.display = "block";

  const st2 = await jget("/api/admin/state");

  // Theme + Dryer minutes in UI
  $("uiTheme").value = st2.uiTheme || "standard";
  $("dryerMinutes").value = String(st2.dryerMinutes || 120);

  $("daysPast").value = st2.daysPast ?? 1;
  $("daysFuture").value = st2.daysFuture ?? 6;

  renderTimeGrid(st2.washerTimes || []);
  renderUserDefect(st2.userDefectEnabled, st2.userDefectAllowed);

  $("newsText").value = st2.newsText || "";
  $("newsEnabled").checked = !!st2.newsEnabled;

  await renderAdminMachines();
  await checkAdminChatUnread(true);

  alert("Admin freigeschaltet.");
}

/* Admin: save theme */
async function adminSaveTheme(){
  const pw = adminPw_();
  if(!pw) return alert("Admin-Passwort fehlt.");
  const uiTheme = $("uiTheme").value;

  await confirmAndRun("Design wirklich speichern?", async ()=>{
    const { data } = await jpost("/api/admin/set-ui-theme", { adminPassword: pw, uiTheme });
    if(data.ok) await refreshAll();
    return data;
  });
}

/* Admin: save dryer minutes */
async function adminSaveDryerMinutes(){
  const pw = adminPw_();
  if(!pw) return alert("Admin-Passwort fehlt.");
  const dryerMinutes = Number($("dryerMinutes").value);

  await confirmAndRun("Trocknerlaufzeit speichern? (gilt nur f√ºr neue Buchungen)", async ()=>{
    const { data } = await jpost("/api/admin/set-dryer-duration", { adminPassword: pw, dryerMinutes });
    return data;
  });
}

function renderTimeGrid(selectedTimes){
  const sel = new Set(selectedTimes);
  const grid = $("timeGrid");
  grid.innerHTML = "";
  for(let h=1; h<=23; h++){
    const t = String(h).padStart(2,"0")+":00";
    const d = document.createElement("div");
    d.className = "card";
    d.innerHTML = `<label><input type="checkbox" id="t_${t.replace(":","")}" ${sel.has(t)?"checked":""}> ${t}</label>`;
    grid.appendChild(d);
  }
}
function collectTimes_(){
  const times = [];
  for(let h=1; h<=23; h++){
    const t = String(h).padStart(2,"0")+":00";
    const id = `t_${t.replace(":","")}`;
    const el = document.getElementById(id);
    if(el && el.checked) times.push(t);
  }
  return times;
}

async function adminSetStationPin(){
  const pw = adminPw_();
  const sp = $("adminStationPin").value.trim();
  if(!pw) return alert("Admin-Passwort fehlt.");
  if(!sp) return alert("Stations-PIN fehlt.");

  await confirmAndRun("Stations-PIN wirklich speichern?", async ()=>{
    const { data } = await jpost("/api/admin/set-station-pin", { adminPassword: pw, stationPin: sp });
    return data;
  });
}

async function adminSaveDays(){
  const pw = adminPw_();
  if(!pw) return alert("Admin-Passwort fehlt.");

  const daysPast = Number($("daysPast").value);
  const daysFuture = Number($("daysFuture").value);

  await confirmAndRun("Tage-Fenster wirklich speichern?", async ()=>{
    const { data } = await jpost("/api/admin/set-days-window", { adminPassword: pw, daysPast, daysFuture });
    if(data.ok) await refreshAll();
    return data;
  });
}

async function adminSaveTimes(){
  const pw = adminPw_();
  if(!pw) return alert("Admin-Passwort fehlt.");
  const times = collectTimes_();
  if(times.length < 1) return alert("Mindestens eine Zeit w√§hlen.");

  await confirmAndRun("Slotzeiten wirklich speichern?", async ()=>{
    const { data } = await jpost("/api/admin/set-washer-times", { adminPassword: pw, times });
    if(data.ok) await refreshAll();
    return data;
  });
}

async function renderAdminMachines(){
  const s = await jget("/api/status");
  if(!s.ok) return;

  const machines = s.machines || [];
  const box = $("adminMachines");
  box.innerHTML = "";

  for(const m of machines){
    const d = document.createElement("div");
    d.className = "card";

    const name = (m.type==="washer" ? "Waschmaschine " : "Trockner ") + m.machine;
    d.innerHTML = `
      <b>${name}</b><br>
      <label class="small"><input type="checkbox" id="en_${m.type}_${m.machine}" ${Number(m.enabled)===1?"checked":""}> Freigegeben</label>
      <label class="small"><input type="checkbox" id="df_${m.type}_${m.machine}" ${Number(m.defect)===1?"checked":""}> Defekt</label>
      <div class="small">Defekt gemeldet von: ${escapeHtml(m.defectBy || "-")}</div>
      <button onclick="adminSaveMachine('${m.type}',${m.machine})">Speichern</button>
    `;
    box.appendChild(d);
  }
}

async function adminSaveMachine(type, machine){
  const pw = adminPw_();
  if(!pw) return alert("Admin-Passwort fehlt.");

  const en = document.getElementById(`en_${type}_${machine}`).checked;
  const df = document.getElementById(`df_${type}_${machine}`).checked;

  await confirmAndRun("Einstellungen wirklich speichern?", async ()=>{
    const { data } = await jpost("/api/admin/set-machine", { adminPassword: pw, type, machine, enabled: en, defect: df });
    if(data.ok){
      await refreshAll();
      await renderAdminMachines();
    }
    return data;
  });
}

function renderUserDefect(enabled, allowed){
  $("udEnabled").checked = !!enabled;
  const grid = $("udGrid");
  grid.innerHTML = "";

  for(const t of ["washer","dryer"]){
    for(let m=1;m<=4;m++){
      const val = (allowed && allowed[t] && allowed[t][m]===true);
      const d = document.createElement("div");
      d.className = "card";
      const label = (t==="washer" ? "Waschmaschine " : "Trockner ") + m;
      d.innerHTML = `<label><input type="checkbox" id="ud_${t}_${m}" ${val?"checked":""}> ${label}</label>`;
      grid.appendChild(d);
    }
  }
}

async function adminSaveUserDefect(){
  const pw = adminPw_();
  if(!pw) return alert("Admin-Passwort fehlt.");

  const enabled = $("udEnabled").checked;
  const allowed = { washer:{}, dryer:{} };
  for(const t of ["washer","dryer"]){
    for(let m=1;m<=4;m++){
      allowed[t][m] = !!document.getElementById(`ud_${t}_${m}`).checked;
    }
  }

  await confirmAndRun("User-Defektmeldung speichern?", async ()=>{
    const { data } = await jpost("/api/admin/set-user-defect", { adminPassword: pw, enabled, allowed });
    return data;
  });
}

async function adminSaveNews(){
  const pw = adminPw_();
  if(!pw) return alert("Admin-Passwort fehlt.");

  const text = $("newsText").value;
  const enabled = $("newsEnabled").checked;

  await confirmAndRun("News speichern?", async ()=>{
    const { data } = await jpost("/api/admin/news/set", { adminPassword: pw, text, enabled });
    if(data.ok) await refreshAll();
    return data;
  });
}

async function adminChangePw(){
  const pw = adminPw_();
  const nw = $("newAdminPw").value.trim();
  if(!pw) return alert("Admin-Passwort fehlt.");
  if(!nw || nw.length < 8) return alert("Neues Passwort mind. 8 Zeichen.");

  await confirmAndRun("Admin-Passwort wirklich √§ndern?", async ()=>{
    const { data } = await jpost("/api/admin/change-password", { adminPassword: pw, newPassword: nw });
    if(data.ok){
      $("adminPw").value = nw;
      $("newAdminPw").value = "";
    }
    return data;
  });
}

/* Admin chat (unchanged) */
async function checkAdminChatUnread(showPopup){
  const pw = adminPw_();
  if(!pw) return;

  const { data } = await jpost("/api/chat/admin/unread-count", { adminPassword: pw });
  if(data.ok && Number(data.count)>0){
    $("adminChatBadge").style.display = "inline-block";
    if(showPopup && !adminChatPopupShown){
      adminChatPopupShown = true;
      alert("üì© Neue Nachricht(en) von Usern im Chat.");
    }
  } else {
    $("adminChatBadge").style.display = "none";
  }
}

async function adminLoadRooms(){
  const pw = adminPw_();
  if(!pw) return alert("Admin-Passwort fehlt.");

  await checkAdminChatUnread(false);

  const { data } = await jpost("/api/chat/admin/rooms", { adminPassword: pw });
  if(!data.ok) return alert(data.error || "Fehler");

  const box = $("adminRooms");
  box.innerHTML = "";

  for(const r of data.rooms || []){
    const d = document.createElement("div");
    d.className = "card";
    const unread = Number(r.unreadFromUser || 0);
    d.innerHTML = `
      <b>Zimmer ${escapeHtml(r.room)}</b>
      ${unread>0 ? `<span class="pill red">${unread} neu</span>` : `<span class="pill">0 neu</span>`}
      <div class="small muted">Letzte Nachricht: ${new Date(Number(r.lastAt||0)).toLocaleString("de-DE")}</div>
      <button onclick="adminSelectRoom('${escapeHtml(r.room)}')">√ñffnen</button>
    `;
    box.appendChild(d);
  }
}

function adminSelectRoom(room){
  adminSelectedRoom = room;
  $("adminRoomTitle").textContent = room;
  $("adminChatBox").style.display = "block";
  adminLoadChat();
}

async function adminLoadChat(){
  const pw = adminPw_();
  if(!pw) return alert("Admin-Passwort fehlt.");
  if(!adminSelectedRoom) return alert("Bitte Zimmer ausw√§hlen.");

  const { data } = await jpost("/api/chat/admin/list", { adminPassword: pw, room: adminSelectedRoom });
  if(!data.ok) return alert(data.error || "Fehler");

  const box = $("adminChatList");
  box.innerHTML = "";

  for(const m of data.messages || []){
    const isAdmin = m.sender === "admin";
    const c = document.createElement("div");
    c.className = `card ${isAdmin ? "busy" : "free"}`;

    const seenUser = (m.sender==="admin" && Number(m.visibleToUser)===1 && m.seenByUserAt && Number(m.seenByUserAt)>0);
    const seenAdmin = (m.sender==="user" && m.seenByAdminAt && Number(m.seenByAdminAt)>0);

    const extra = [];
    if(m.sender==="admin"){
      extra.push(Number(m.visibleToUser)===1 ? `<span class="pill">sichtbar</span>` : `<span class="pill red">unsichtbar</span>`);
      extra.push(seenUser ? `<span class="pill green">User gelesen</span>` : `<span class="pill">User ungelesen</span>`);
    } else {
      extra.push(seenAdmin ? `<span class="pill green">Admin gelesen</span>` : `<span class="pill">Admin ungelesen</span>`);
    }

    c.innerHTML = `
      <b>${isAdmin ? "Admin" : "User"}</b>
      <span class="small muted">${new Date(m.createdAt).toLocaleString("de-DE")}</span>
      ${extra.join(" ")}
      <div style="margin-top:6px;">${escapeHtml(m.body)}</div>
    `;
    box.appendChild(c);
  }

  await checkAdminChatUnread(false);
}

async function adminSendChat(){
  const pw = adminPw_();
  if(!pw) return alert("Admin-Passwort fehlt.");
  if(!adminSelectedRoom) return alert("Bitte Zimmer ausw√§hlen.");

  const text = $("adminChatText").value.trim();
  if(!text) return alert("Text fehlt.");

  const visibleToUser = $("adminVisibleToUser").checked;

  const { data } = await jpost("/api/chat/admin/send", { adminPassword: pw, room: adminSelectedRoom, text, visibleToUser });
  if(!data.ok) return alert(data.error || "Fehler");

  $("adminChatText").value = "";
  await adminLoadChat();
}

/* Admin Log (formatted) */
async function adminLoadLog(){
  const pw = adminPw_();
  if(!pw) return alert("Admin-Passwort fehlt.");

  const { data } = await jpost("/api/admin/log/list", { adminPassword: pw, limit: 300 });
  if(!data.ok) return alert(data.error || "Fehler");

  const box = $("adminLog");
  box.innerHTML = "";
  for(const r of data.rows || []){
    const c = document.createElement("div");
    c.className = "card";
    c.innerHTML = `
      <b>${new Date(Number(r.ts||0)).toLocaleString("de-DE")}</b>
      <span class="pill">${escapeHtml(r.action||"")}</span>
      <div class="small">
        ${r.type ? `${escapeHtml(r.type)} ${escapeHtml(r.machine)}` : ""}
        ${r.room ? ` | Zimmer ${escapeHtml(r.room)}` : ""}
      </div>
      <div class="small muted">${formatLogDetails(r.details||"")}</div>
    `;
    box.appendChild(c);
  }
}

/* refresh */
async function refreshAll(){
  setStatus("Aktualisiere‚Ä¶");
  const st = await jget("/api/status");
  if(!st.ok){
    setStatus("Fehler: " + (st.error || "Status"));
    return;
  }
  lastStatus = st;

  applyTheme(st.config?.uiTheme || "standard");
  updateNewsUI(st.newsText || "");

  await loadMyBookings();
  renderMachinesOverview(st);

  await loadWasherSlots();
  await checkUserChatUnread();

  setStatus("Bereit.");
}

/* Enter = Admin Login */
window.addEventListener("load", () => {
  const apw = document.getElementById("adminPw");
  if(apw){
    apw.addEventListener("keydown", (e) => {
      if(e.key === "Enter"){
        e.preventDefault();
        adminUnlock();
      }
    });
  }
});

/* chat check 20s */
setInterval(() => {
  checkUserChatUnread().catch(()=>{});
}, 20000);

/* initial */
refreshAll();
</script>

</body>
</html>
