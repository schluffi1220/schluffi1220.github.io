<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Wasch-Portal</title>
<style>
  body { font-family: Arial, sans-serif; margin: 14px; max-width: 980px; }
  h1 { margin: 0 0 6px; }
  h2 { margin: 14px 0 8px; }
  label { font-weight: bold; display:block; margin-top: 10px; }
  input, select, textarea {
    width: 100%; padding: 10px; margin-top: 5px; box-sizing: border-box;
    font-size: 16px; border-radius: 10px; border: 1px solid #ddd;
  }
  button {
    width: 100%; padding: 11px; margin-top: 8px; cursor: pointer;
    font-size: 16px; border-radius: 10px; border: 1px solid #ddd; background: #f2f2f2;
  }

  .grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
  .card { border: 1px solid #ddd; border-radius: 12px; padding: 12px; }
  .free { background: #e8f5e9; }
  .busy { background: #e3f2fd; }
  .blocked { background: #ffebee; opacity: 0.95; }

  .muted { opacity: 0.85; }
  .small { font-size: 13px; opacity: 0.9; }
  .status { margin-top: 10px; padding: 10px; border-radius: 10px; border: 1px solid #ddd; background: #fafafa; }
  details { margin-top: 12px; }
  .row2 { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
  .topbar { display:flex; align-items:center; justify-content:space-between; gap: 10px; }
  .link { font-size: 14px; text-decoration: underline; cursor: pointer; opacity: 0.8; user-select:none; }

  /* ===== Maschinenübersicht: LIST (UI A) ===== */
  .mlist { border: 1px solid #ddd; border-radius: 12px; overflow: hidden; }
  .mrow {
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    padding: 10px 12px; border-top: 1px solid #eee;
  }
  .mrow:first-child { border-top: 0; }
  .mleft { display:flex; align-items:flex-start; gap:10px; }
  .mdot { width: 14px; height: 14px; border-radius: 50%; margin-top: 3px; border: 1px solid rgba(0,0,0,0.15); }
  .mname { font-weight: 700; line-height: 1.2; }
  .mmeta { font-size: 13px; opacity: 0.85; margin-top: 2px; }
  .mbtn { width: auto; padding: 8px 12px; font-size: 14px; border-radius: 10px; }
  .mbtn[disabled]{ opacity: 0.55; cursor: not-allowed; }

  /* ===== Maschinenübersicht: CARDS (UI B) ===== */
  .mcards { display: grid; grid-template-columns: 1fr; gap: 10px; }
  @media (min-width: 760px){ .mcards { grid-template-columns: 1fr 1fr; } }
  .mcard { border: 1px solid #ddd; border-radius: 12px; padding: 12px; }
  .mcard .top { display:flex; justify-content:space-between; gap:10px; align-items:flex-start; }
  .mbadge { display:inline-block; padding: 2px 8px; border-radius: 999px; border:1px solid #ddd; font-size: 12px; }
  .mbadge.free { background:#e8f5e9; }
  .mbadge.busy { background:#e3f2fd; }
  .mbadge.bad  { background:#ffebee; }

  /* ===== Theme: High Contrast (Magenta) ===== */
  body.theme-hc .blocked { background: #ffe0f0; }
  body.theme-hc .mbadge.bad { background: #ffe0f0; border-color: #d81b60; }
  body.theme-hc .mdot.bad { background: #d81b60 !important; border-color: #7a0030; }
</style>
</head>
<body>

<div class="topbar">
  <div>
    <h1>Wasch-Portal</h1>
    <div class="small muted" id="subline">Cloudflare Worker + D1</div>
  </div>
  <div class="link" onclick="toggleAdmin()">Admin</div>
</div>

<div id="news" class="status" style="display:none;"></div>
<div id="status" class="status">Lade…</div>

<h2>1) Zugang</h2>
<label>Zimmernummer</label>
<input id="room" placeholder="z. B. 316" inputmode="numeric" />

<label>Persönlicher PIN</label>
<input id="pin" type="password" placeholder="4-stellig" inputmode="numeric" />

<label>Stations-PIN (für Buchen erforderlich)</label>
<input id="stationPin" type="password" placeholder="Stations-PIN" inputmode="numeric" />

<button onclick="refreshAll()">Aktualisieren</button>

<h2>2) Maschinenübersicht</h2>
<div id="machinesOverview"></div>

<h2>3) Waschmaschinen-Slot buchen</h2>
<label>Slot</label>
<select id="washerSlotSelect">
  <option value="">Bitte auswählen</option>
</select>
<button onclick="bookWasher()">Buchen</button>

<h2>4) Meine Buchungen</h2>
<button onclick="loadMyBookings()">Meine Buchungen aktualisieren</button>
<div id="myBookings" class="grid"></div>

<details>
  <summary><b>Maschine als defekt melden / freigeben (mit Stations-PIN)</b></summary>
  <div class="row2">
    <div>
      <label>Gerät</label>
      <select id="defType">
        <option value="washer">Waschmaschine</option>
        <option value="dryer">Trockner</option>
      </select>
    </div>
    <div>
      <label>Nummer</label>
      <select id="defMachine">
        <option value="1">1</option><option value="2">2</option>
        <option value="3">3</option><option value="4">4</option>
      </select>
    </div>
  </div>
  <button onclick="userSetDefect('defect')">Als defekt melden</button>
  <button onclick="userSetDefect('free')">Freigeben</button>
  <div class="small muted">Hinweis: Bitte zusätzlich der Rezeption Bescheid geben.</div>
</details>

<details>
  <summary><b>Feedback / Problem melden</b></summary>
  <label>Feedback</label>
  <textarea id="fb" rows="4" placeholder="Was ist aufgefallen? (z. B. Maschine 2 laut, App klemmt, ...)"></textarea>
  <button onclick="sendFeedback()">Feedback senden</button>
</details>

<!-- Admin Panel -->
<div id="adminPanel" style="display:none; margin-top: 16px; border-top:1px solid #ddd; padding-top: 12px;">
  <h2>Admin</h2>

  <label>Admin-Passwort</label>
  <input id="adminPw" type="password" placeholder="Admin-Passwort" />
  <button onclick="adminUnlock()">Login</button>

  <div id="adminBody" style="display:none;">
    <details open>
      <summary><b>UI / Design (GLOBAL)</b></summary>

      <label>Layout</label>
      <select id="uiLayout">
        <option value="list">Liste (kompakt)</option>
        <option value="cards">Karten (groß)</option>
      </select>

      <label>Theme</label>
      <select id="uiTheme">
        <option value="standard">Standard</option>
        <option value="highcontrast-magenta">High Contrast (Magenta)</option>
      </select>

      <button onclick="adminSaveUI()">Speichern (Passwort bestätigen)</button>
      <div class="small muted">Wirkt global für alle User (nach Refresh / Cache-Reload).</div>
    </details>

    <details open>
      <summary><b>Stations-PIN</b></summary>
      <label>Stations-PIN setzen/ändern</label>
      <input id="adminStationPin" type="password" placeholder="Stations-PIN" inputmode="numeric" />
      <button onclick="adminSetStationPin()">Stations-PIN speichern (Passwort bestätigen)</button>
    </details>

    <details open>
      <summary><b>Trocknerlaufzeit</b></summary>
      <label>Dauer</label>
      <select id="dryerMinutes">
        <option value="60">1 Stunde</option>
        <option value="90">1,5 Stunden</option>
        <option value="120">2 Stunden</option>
      </select>
      <button onclick="adminSaveDryerDuration()">Speichern (Passwort bestätigen)</button>
    </details>

    <details>
      <summary><b>Tage-Fenster</b></summary>
      <div class="row2">
        <div>
          <label>Vergangene Tage (Anzeige)</label>
          <input id="daysPast" inputmode="numeric" placeholder="z. B. 1" />
        </div>
        <div>
          <label>Folgende Tage (Anzeige)</label>
          <input id="daysFuture" inputmode="numeric" placeholder="z. B. 6" />
        </div>
      </div>
      <button onclick="adminSaveDays()">Speichern (Passwort bestätigen)</button>
    </details>

    <details open>
      <summary><b>Waschmaschinen Slotzeiten</b></summary>
      <div class="small muted">Beispiel: 06:00, 08:00, … (durch Komma trennen)</div>
      <input id="washerTimes" placeholder="06:00,08:00,10:00,12:00,14:00,..." />
      <button onclick="adminSaveTimes()">Slotzeiten speichern (Passwort bestätigen)</button>
    </details>

    <details open>
      <summary><b>Maschinen freigeben / sperren / defekt</b></summary>
      <div id="adminMachines" class="grid"></div>
    </details>

    <details>
      <summary><b>User dürfen defekt melden?</b></summary>
      <label><input type="checkbox" id="udEnabled"> User-Defektmeldungen aktiv</label>
      <div id="udGrid" class="grid"></div>
      <button onclick="adminSaveUserDefect()">Speichern (Passwort bestätigen)</button>
    </details>

    <details>
      <summary><b>Neu in der Version (User-Anzeige)</b></summary>
      <label>Text</label>
      <textarea id="newsText" rows="4" placeholder="z. B. Neu: High-Contrast UI..."></textarea>
      <label><input type="checkbox" id="newsEnabled"> Für User anzeigen</label>
      <button onclick="adminSaveNews()">Speichern (Passwort bestätigen)</button>
    </details>

    <details>
      <summary><b>Feedback (anzeigen / beantworten / löschen)</b></summary>
      <button onclick="adminLoadFeedback()">Feedback anzeigen (Passwort bestätigt)</button>
      <div id="feedbackList" class="grid"></div>
    </details>

    <details>
      <summary><b>Admin-Passwort ändern</b></summary>
      <label>Neues Admin-Passwort (mind. 8 Zeichen)</label>
      <input id="newAdminPw" type="password" placeholder="Neues Passwort" />
      <button onclick="adminChangePw()">Passwort ändern (Passwort bestätigen)</button>
    </details>
  </div>
</div>

<script>
// Wenn du GitHub Pages nutzt: hier Worker-URL eintragen:
const API_BASE = ""; // z.B. "https://snowy-breeze-54f8.schluffi1220.workers.dev"

const $ = (id) => document.getElementById(id);
function setStatus(msg){ $("status").textContent = msg; }

async function jget(path){
  const r = await fetch(API_BASE + path, { cache:"no-store" });
  return await r.json().catch(()=>({}));
}
async function jpost(path, body){
  const r = await fetch(API_BASE + path, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body||{})
  });
  const data = await r.json().catch(()=>({}));
  return { r, data };
}

function needAccess_(){
  return {
    room: $("room").value.trim(),
    pin: $("pin").value.trim(),
    stationPin: $("stationPin").value.trim()
  };
}

function bookingConfirmText_(){
  return "Buchung bestätigen?\n\n" +
    "Wenn du deine gebuchte Zeit überschreitest, ist der nächste berechtigt, die Wäsche vorsichtig in den Korb zu räumen.";
}

// Global config from worker
let cfg = { uiLayout:"list", uiTheme:"standard", dryerMinutes:120 };
let lastStatus = null;

// ---------- Load ----------
async function refreshAll(){
  await loadStatus();
  await loadWasherSlots();
  await loadMyBookings();
}

function applyTheme(){
  document.body.classList.toggle("theme-hc", cfg.uiTheme === "highcontrast-magenta");
}

async function loadStatus(){
  setStatus("Aktualisiere…");
  const data = await jget("/api/status");
  if(!data.ok){ setStatus("Fehler beim Laden."); return; }

  cfg = data.config || cfg;
  applyTheme();

  // News
  if(data.newsText && String(data.newsText).trim()){
    $("news").style.display = "block";
    $("news").textContent = data.newsText;
  } else {
    $("news").style.display = "none";
  }

  lastStatus = data;
  renderMachinesOverview(data);

  setStatus("Bereit.");
}

function renderMachinesOverview(data){
  const layout = (cfg.uiLayout === "cards") ? "cards" : "list";
  if(layout === "cards") renderMachinesOverviewCards(data);
  else renderMachinesOverviewList(data);
}

function machineTitle_(m){
  return (m.type==="washer" ? "Waschmaschine" : "Trockner") + " " + m.machine;
}

function renderMachinesOverviewList(data){
  const box = $("machinesOverview");
  box.className = "mlist";
  box.innerHTML = "";

  const machines = (data.machines || []).slice();
  const bookings = data.bookings || [];

  const active = new Map();
  bookings.forEach(b=> active.set(`${b.type}:${b.machine}`, b));

  machines.sort((a,b)=>{
    if(a.type!==b.type) return a.type.localeCompare(b.type);
    return Number(a.machine)-Number(b.machine);
  });

  for(const m of machines){
    const b = active.get(`${m.type}:${m.machine}`);

    const blocked = (Number(m.enabled)===0);
    const defect = (Number(m.defect)===1);
    const busy = !!b;

    let dotClass = "";
    let dotColor = "#2e7d32"; // green
    let meta = "Frei";

    if(defect){
      dotClass = "bad";
      dotColor = "#c62828"; // red (standard)
      meta = "Defekt";
    } else if(blocked){
      dotClass = "bad";
      dotColor = "#c62828";
      meta = "Gesperrt";
    } else if(busy){
      dotColor = "#1565c0"; // blue
      meta = `Belegt bis ${fmtTime(b.end)} (Zimmer ${escapeHtml(b.room||"?")})`;
    }

    const row = document.createElement("div");
    row.className = "mrow";

    const left = document.createElement("div");
    left.className = "mleft";

    const dot = document.createElement("div");
    dot.className = `mdot ${dotClass}`;
    dot.style.background = dotColor;

    const text = document.createElement("div");
    text.innerHTML = `<div class="mname">${machineTitle_(m)}</div><div class="mmeta">${meta}</div>`;

    left.appendChild(dot);
    left.appendChild(text);
    row.appendChild(left);

    // Right action: dryer quick action
    const right = document.createElement("div");

    if(m.type==="dryer" && !blocked && !defect){
      if(!busy){
        const btn = document.createElement("button");
        btn.className = "mbtn";
        btn.textContent = "Buchen";
        btn.onclick = ()=>bookDryer(m.machine);
        right.appendChild(btn);
      } else {
        // Only show FERTIG if it's your room/pin booking (we won't know here),
        // so button stays disabled; real finish is in "Meine Buchungen".
        const btn = document.createElement("button");
        btn.className = "mbtn";
        btn.textContent = "Belegt";
        btn.disabled = true;
        right.appendChild(btn);
      }
    }

    row.appendChild(right);
    box.appendChild(row);
  }
}

function renderMachinesOverviewCards(data){
  const box = $("machinesOverview");
  box.className = "mcards";
  box.innerHTML = "";

  const machines = (data.machines || []).slice();
  const bookings = data.bookings || [];

  const active = new Map();
  bookings.forEach(b=> active.set(`${b.type}:${b.machine}`, b));

  machines.sort((a,b)=>{
    if(a.type!==b.type) return a.type.localeCompare(b.type);
    return Number(a.machine)-Number(b.machine);
  });

  for(const m of machines){
    const b = active.get(`${m.type}:${m.machine}`);

    const blocked = (Number(m.enabled)===0);
    const defect = (Number(m.defect)===1);

    let state = "free";
    let label = "Frei";
    let badge = "Frei";

    if(defect){ state="bad"; badge="Defekt"; label="Defekt"; }
    else if(blocked){ state="bad"; badge="Gesperrt"; label="Gesperrt"; }
    else if(b){
      state="busy"; badge="Belegt";
      label = `Belegt bis ${fmtTime(b.end)} (Zimmer ${escapeHtml(b.room||"?")})`;
    }

    const card = document.createElement("div");
    card.className = `mcard ${state==="free"?"free":state==="busy"?"busy":"blocked"}`;

    card.innerHTML = `
      <div class="top">
        <div>
          <div style="font-weight:700;">${machineTitle_(m)}</div>
          <div class="small">${label}</div>
        </div>
        <span class="mbadge ${state==="free"?"free":state==="busy"?"busy":"bad"}">${badge}</span>
      </div>
    `;

    // action for dryer
    if(m.type==="dryer" && !blocked && !defect){
      const btn = document.createElement("button");
      btn.textContent = b ? "Belegt" : "Buchen";
      btn.disabled = !!b;
      btn.onclick = ()=>bookDryer(m.machine);
      card.appendChild(btn);
    }

    box.appendChild(card);
  }
}

async function loadWasherSlots(){
  const { stationPin } = needAccess_();
  const sel = $("washerSlotSelect");
  sel.innerHTML = `<option value="">Bitte auswählen</option>`;

  if(!stationPin){
    sel.innerHTML = `<option value="">Bitte Stations-PIN eingeben</option>`;
    return;
  }

  const { data } = await jpost("/api/washer/free-slots", { stationPin });
  if(!data.ok){
    sel.innerHTML = `<option value="">${data.error || "Keine Slots"}</option>`;
    return;
  }

  const slots = data.slots || [];
  if(slots.length===0){
    sel.innerHTML = `<option value="">Keine Slots</option>`;
    return;
  }

  slots.sort((a,b)=> (a.start-b.start) || (a.machine-b.machine));

  for(const s of slots){
    const opt = document.createElement("option");
    opt.value = JSON.stringify({ machine:s.machine, start:s.start, end:s.end });
    opt.textContent = s.label;

    // Show busy/blocked/defect as disabled
    opt.disabled = !s.bookable;
    sel.appendChild(opt);
  }
}

async function bookWasher(){
  const { room, pin, stationPin } = needAccess_();
  if(!room || !pin || !stationPin){
    alert("Bitte Zimmernummer, PIN und Stations-PIN eingeben.");
    return;
  }
  const val = $("washerSlotSelect").value;
  if(!val){
    alert("Bitte einen Slot auswählen.");
    return;
  }

  if(!confirm(bookingConfirmText_())) return;

  const slot = JSON.parse(val);
  const { data } = await jpost("/api/washer/book", {
    room, pin, stationPin,
    machine: slot.machine,
    start: slot.start,
    end: slot.end
  });

  if(data.ok){
    alert("Buchung erfolgreich.");
    await refreshAll();
  }else{
    alert(data.error || "Fehler beim Buchen.");
    await refreshAll();
  }
}

async function bookDryer(machine){
  const { room, pin, stationPin } = needAccess_();
  if(!room || !pin || !stationPin){
    alert("Bitte Zimmernummer, PIN und Stations-PIN eingeben.");
    return;
  }
  const ok = confirm(`Trockner buchen?\n\nDauer: ${cfg.dryerMinutes || 120} Minuten.`);
  if(!ok) return;

  const { data } = await jpost("/api/dryer/book", { room, pin, stationPin, machine });
  if(data.ok){
    alert("Trockner gebucht.");
    await refreshAll();
  }else{
    alert(data.error || "Fehler.");
    await refreshAll();
  }
}

async function loadMyBookings(){
  const { room, pin } = needAccess_();
  const box = $("myBookings");
  box.innerHTML = "";

  if(!room || !pin){
    box.innerHTML = `<div class="card muted">Bitte Zimmernummer und PIN eingeben.</div>`;
    return;
  }

  const { data } = await jpost("/api/my-bookings", { room, pin });
  if(!data.ok){
    box.innerHTML = `<div class="card blocked">${escapeHtml(data.error || "Fehler")}</div>`;
    return;
  }

  const list = data.bookings || [];
  if(list.length===0){
    box.innerHTML = `<div class="card muted">Keine Buchungen gefunden.</div>`;
    return;
  }

  list.sort((a,b)=>a.start-b.start);

  for(const b of list){
    const isWasher = b.type==="washer";
    const title = isWasher ? `Waschmaschine ${b.machine}` : `Trockner ${b.machine}`;
    const start = new Date(b.start);
    const end = new Date(b.end);
    const line = isWasher
      ? `${start.toLocaleDateString("de-DE")} ${start.toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"})} – ${end.toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"})}`
      : `bis ${end.toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"})}`;

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `<b>${title}</b><br><div class="small">${line}</div>`;

    if(isWasher){
      const btn = document.createElement("button");
      btn.textContent = b.canCancel ? "Stornieren" : "Storno nicht möglich";
      btn.disabled = !b.canCancel;
      btn.onclick = ()=>cancelBooking(b.id);
      card.appendChild(btn);
    } else {
      const btn = document.createElement("button");
      btn.textContent = b.canFinish ? "FERTIG" : "Abgelaufen";
      btn.disabled = !b.canFinish;
      btn.onclick = ()=>finishDryer(b.id);
      card.appendChild(btn);
    }

    box.appendChild(card);
  }
}

async function cancelBooking(id){
  const { pin } = needAccess_();
  if(!pin) return alert("PIN fehlt.");
  if(!confirm("Buchung wirklich stornieren?")) return;

  const { data } = await jpost("/api/cancel", { id, pin });
  if(data.ok){
    alert("Storniert.");
    await refreshAll();
  }else{
    alert(data.error || "Fehler.");
    await refreshAll();
  }
}

async function finishDryer(id){
  const { pin } = needAccess_();
  if(!pin) return alert("PIN fehlt.");
  if(!confirm("Trockner als FERTIG markieren?")) return;

  const { data } = await jpost("/api/dryer/finish", { id, pin });
  if(data.ok){
    alert("Erledigt.");
    await refreshAll();
  }else{
    alert(data.error || "Fehler.");
    await refreshAll();
  }
}

async function sendFeedback(){
  const { room, pin } = needAccess_();
  const message = $("fb").value.trim();
  if(!room || !message){
    alert("Bitte Zimmernummer und Feedback eingeben.");
    return;
  }
  const { data } = await jpost("/api/feedback", { room, pin, message });
  if(data.ok){
    alert("Danke! Feedback wurde gesendet.");
    $("fb").value = "";
  }else{
    alert(data.error || "Fehler.");
  }
}

async function userSetDefect(action){
  const { room, stationPin } = needAccess_();
  const type = $("defType").value;
  const machine = Number($("defMachine").value);

  if(!stationPin){
    alert("Stations-PIN fehlt.");
    return;
  }

  const ok = confirm(action==="defect"
    ? "Gerät wirklich als DEFekt melden?\n\nBitte zusätzlich der Rezeption Bescheid geben."
    : "Gerät wirklich FREIGEBEN?");
  if(!ok) return;

  const { data } = await jpost("/api/user/set-defect", { stationPin, room, type, machine, action });
  if(data.ok){
    alert("Gespeichert.");
    await refreshAll();
  }else{
    alert(data.error || "Fehler.");
  }
}

// ---------- Admin ----------
function toggleAdmin(){
  const p = $("adminPanel");
  p.style.display = (p.style.display==="none" ? "block" : "none");
}

$("adminPw").addEventListener("keydown", (e)=>{
  if(e.key === "Enter") adminUnlock();
});

async function adminUnlock(){
  let pw = $("adminPw").value.trim();
  if(!pw){ alert("Admin-Passwort eingeben."); return; }

  const st = await jget("/api/admin/state");
  if(!st.ok){ alert("Admin-State konnte nicht geladen werden."); return; }

  if(!st.hasAdmin){
    const init = prompt("Admin-Passwort ist noch nicht gesetzt.\nInitiales Passwort (mind. 8 Zeichen) setzen:");
    if(!init || init.length < 8){ alert("Zu kurz."); return; }
    const { data } = await jpost("/api/admin/set-initial-password", { newPassword: init });
    if(!data.ok){ alert(data.error || "Fehler"); return; }
    $("adminPw").value = init;
    pw = init;
  }

  $("adminBody").style.display = "block";

  // Fill state
  const st2 = await jget("/api/admin/state");
  $("daysPast").value = st2.daysPast ?? 1;
  $("daysFuture").value = st2.daysFuture ?? 6;
  $("washerTimes").value = (st2.washerTimes || []).join(",");
  $("dryerMinutes").value = String(st2.dryerMinutes || 120);

  $("uiLayout").value = st2.uiLayout || "list";
  $("uiTheme").value = st2.uiTheme || "standard";

  $("adminStationPin").value = "";

  await renderMachines();
  renderUserDefect(st2.userDefectEnabled, st2.userDefectAllowed);

  $("newsText").value = st2.newsText || "";
  $("newsEnabled").checked = !!st2.newsEnabled;

  alert("Admin freigeschaltet.");
}

function adminPw_(){ return $("adminPw").value.trim(); }

async function adminSaveUI(){
  const pw = adminPw_();
  if(!pw) return alert("Admin-Passwort fehlt.");

  if(!confirm("Sicher speichern?")) return;

  const uiLayout = $("uiLayout").value;
  const uiTheme = $("uiTheme").value;

  const { data } = await jpost("/api/admin/set-ui", { adminPassword: pw, uiLayout, uiTheme });
  if(data.ok){
    alert("Gespeichert.");
    await refreshAll();
  } else alert(data.error || "Fehler.");
}

async function adminSetStationPin(){
  const pw = adminPw_();
  if(!pw) return alert("Admin-Passwort fehlt.");
  const sp = $("adminStationPin").value.trim();
  if(!sp) return alert("Stations-PIN eingeben.");

  const { data } = await jpost("/api/admin/set-station-pin", { adminPassword: pw, stationPin: sp });
  if(data.ok) alert("Stations-PIN gespeichert.");
  else alert(data.error || "Fehler.");
}

async function adminSaveDryerDuration(){
  const pw = adminPw_();
  if(!pw) return alert("Admin-Passwort fehlt.");

  if(!confirm("Sicher speichern?")) return;

  const dryerMinutes = Number($("dryerMinutes").value);
  const { data } = await jpost("/api/admin/set-dryer-duration", { adminPassword: pw, dryerMinutes });
  if(data.ok){
    alert("Gespeichert.");
    await refreshAll();
  } else alert(data.error || "Fehler.");
}

async function adminSaveTimes(){
  const pw = adminPw_();
  if(!pw) return alert("Admin-Passwort fehlt.");

  if(!confirm("Sicher speichern?")) return;

  const raw = $("washerTimes").value;
  const times = raw.split(",").map(s=>s.trim()).filter(Boolean);
  const { data } = await jpost("/api/admin/set-washer-times", { adminPassword: pw, times });
  if(data.ok){
    alert("Slotzeiten gespeichert.");
    await refreshAll();
  } else alert(data.error || "Fehler.");
}

async function adminSaveDays(){
  const pw = adminPw_();
  if(!pw) return alert("Admin-Passwort fehlt.");

  if(!confirm("Sicher speichern?")) return;

  const daysPast = Number($("daysPast").value);
  const daysFuture = Number($("daysFuture").value);

  const { data } = await jpost("/api/admin/set-days-window", { adminPassword: pw, daysPast, daysFuture });
  if(data.ok){
    alert("Gespeichert.");
    await refreshAll();
  } else alert(data.error || "Fehler.");
}

async function renderMachines(){
  const s = await jget("/api/status");
  const machines = s.machines || [];
  const box = $("adminMachines");
  box.innerHTML = "";

  machines.forEach(m=>{
    const d = document.createElement("div");
    d.className = "card";
    const name = machineTitle_(m);
    d.innerHTML = `
      <b>${name}</b><br>
      <label class="small"><input type="checkbox" id="en_${m.type}_${m.machine}" ${m.enabled? "checked":""}> Freigegeben</label>
      <label class="small"><input type="checkbox" id="df_${m.type}_${m.machine}" ${m.defect? "checked":""}> Defekt</label>
      <div class="small">Defekt gemeldet von: ${escapeHtml(m.defectBy || "-")}</div>
      <button onclick="adminSaveMachine('${m.type}',${m.machine})">Speichern (Passwort bestätigen)</button>
    `;
    box.appendChild(d);
  });
}

async function adminSaveMachine(type, machine){
  const pw = adminPw_();
  if(!pw) return alert("Admin-Passwort fehlt.");

  if(!confirm("Sicher speichern?")) return;

  const en = document.getElementById(`en_${type}_${machine}`).checked;
  const df = document.getElementById(`df_${type}_${machine}`).checked;

  const { data } = await jpost("/api/admin/set-machine", { adminPassword: pw, type, machine, enabled: en, defect: df });
  if(data.ok){
    alert("Gespeichert.");
    await refreshAll();
    await renderMachines();
  } else {
    alert(data.error || "Fehler.");
    await renderMachines();
  }
}

function renderUserDefect(enabled, allowed){
  $("udEnabled").checked = !!enabled;
  const grid = $("udGrid");
  grid.innerHTML = "";

  const types = ["washer","dryer"];
  for(const t of types){
    for(let m=1;m<=4;m++){
      const d = document.createElement("div");
      d.className = "card";
      const key = (t==="washer" ? "Waschmaschine" : "Trockner") + " " + m;
      const val = (allowed && allowed[t] && (allowed[t][m]===true || allowed[t][String(m)]===true));
      d.innerHTML = `<label><input type="checkbox" id="ud_${t}_${m}" ${val?"checked":""}> ${key}</label>`;
      grid.appendChild(d);
    }
  }
}

async function adminSaveUserDefect(){
  const pw = adminPw_();
  if(!pw) return alert("Admin-Passwort fehlt.");

  if(!confirm("Sicher speichern?")) return;

  const enabled = $("udEnabled").checked;
  const allowed = { washer:{}, dryer:{} };
  ["washer","dryer"].forEach(t=>{
    for(let m=1;m<=4;m++){
      const el = document.getElementById(`ud_${t}_${m}`);
      allowed[t][m] = !!(el && el.checked);
    }
  });

  const { data } = await jpost("/api/admin/set-user-defect", { adminPassword: pw, enabled, allowed });
  if(data.ok) alert("Gespeichert.");
  else alert(data.error || "Fehler.");
}

async function adminSaveNews(){
  const pw = adminPw_();
  if(!pw) return alert("Admin-Passwort fehlt.");

  if(!confirm("Sicher speichern?")) return;

  const text = $("newsText").value;
  const enabled = $("newsEnabled").checked;

  const { data } = await jpost("/api/admin/news/set", { adminPassword: pw, text, enabled });
  if(data.ok){
    alert("Gespeichert.");
    await refreshAll();
  } else alert(data.error || "Fehler.");
}

async function adminLoadFeedback(){
  const pw = adminPw_();
  if(!pw) return alert("Admin-Passwort fehlt.");

  const { data } = await jpost("/api/admin/feedback/list", { adminPassword: pw });
  if(!data.ok) return alert(data.error || "Fehler.");

  const box = $("feedbackList");
  box.innerHTML = "";

  data.rows.forEach(r=>{
    const dt = new Date(r.createdAt).toLocaleString("de-DE");
    const el = document.createElement("div");
    el.className = "card";
    el.innerHTML = `
      <b>${dt}</b> | Zimmer ${escapeHtml(r.room)}<br>
      <div>${escapeHtml(r.message)}</div>
      <div class="small">Antwort: ${r.adminReply ? escapeHtml(r.adminReply) : "-"}</div>
      <textarea id="rep_${r.id}" rows="2" placeholder="Antwort schreiben..."></textarea>
      <button onclick="adminReply('${r.id}')">Antwort speichern</button>
      <button onclick="adminDeleteFb('${r.id}')">Löschen</button>
    `;
    box.appendChild(el);
  });
}

async function adminReply(id){
  const pw = adminPw_();
  const reply = document.getElementById(`rep_${id}`).value.trim();
  if(!reply) return alert("Antwort eingeben.");

  if(!confirm("Antwort speichern?")) return;

  const { data } = await jpost("/api/admin/feedback/reply", { adminPassword: pw, id, reply });
  if(data.ok){
    alert("Antwort gespeichert.");
    adminLoadFeedback();
  } else alert(data.error || "Fehler.");
}

async function adminDeleteFb(id){
  const pw = adminPw_();
  if(!confirm("Feedback wirklich löschen?")) return;

  const { data } = await jpost("/api/admin/feedback/delete", { adminPassword: pw, id });
  if(data.ok){
    alert("Gelöscht.");
    adminLoadFeedback();
  } else alert(data.error || "Fehler.");
}

async function adminChangePw(){
  const pw = adminPw_();
  const nw = $("newAdminPw").value.trim();
  if(!pw) return alert("Admin-Passwort fehlt.");
  if(!nw || nw.length < 8) return alert("Neues Passwort mind. 8 Zeichen.");

  if(!confirm("Passwort wirklich ändern?")) return;

  const { data } = await jpost("/api/admin/change-password", { adminPassword: pw, newPassword: nw });
  if(data.ok){
    alert("Admin-Passwort geändert.");
    $("adminPw").value = nw;
    $("newAdminPw").value = "";
  } else alert(data.error || "Fehler.");
}

function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
}
function fmtTime(ms){
  return new Date(ms).toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"});
}

refreshAll();
</script>

</body>
</html>
